<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HotTracküî•</title>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0f172a"/>

    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ö°Ô∏è</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f172a; /* slate-900 */
            --bg-secondary: #1e293b; /* slate-800 */
            --bg-card: rgba(30, 41, 59, 0.6); /* slate-800 com transpar√™ncia */
            --border-color: #334155; /* slate-700 */
            --accent-primary: #38bdf8; /* sky-400 */
            --accent-secondary: #0ea5e9; /* sky-500 */
            --text-primary: #f1f5f9; /* slate-100 */
            --text-secondary: #94a3b8; /* slate-400 */
            --success: #4ade80; /* green-400 */
            --danger: #f87171; /* red-400 */
            --warning: #facc15; /* yellow-400 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            background-image:
                radial-gradient(circle at 1px 1px, rgba(56, 189, 248, 0.1) 1px, transparent 0),
                radial-gradient(circle at top left, rgba(56, 189, 248, 0.2), transparent 30%),
                radial-gradient(circle at bottom right, rgba(14, 165, 233, 0.2), transparent 40%);
            background-size: 20px 20px, 100% 100%, 100% 100%;
        }

        /* Corre√ß√£o para scroll de main#content */
        html, body, #app, .md\:flex {
            height: 100%;
            overflow: hidden; /* Impede scroll no body */
        }
        main#content {
            height: 100%; /* Altura total por padr√£o */
        }
        main#content.overflow-y-auto {
             height: calc(100% - 72px); /* 100% da altura menos o header mobile */
        }
        @media (min-width: 768px) { /* md */
            main#content.overflow-y-auto {
                height: 100%; /* Em desktop, o header n√£o afeta */
            }
        }
        /* Fim da corre√ß√£o */


        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .form-input, .form-select, .form-date, .form-textarea {
            background-color: rgba(15, 23, 42, 0.7);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: all 0.3s ease;
            border-radius: 0.375rem;
        }

        .form-input:focus, .form-select:focus, .form-date:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2);
        }

        .form-date::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
        }

        .btn {
            background-color: var(--accent-secondary);
            color: white;
            transition: all 0.3s ease;
            border: 1px solid var(--accent-primary);
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.2), inset 0 0 8px rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            border-radius: 0.375rem; /* Adicionado raio de borda padr√£o */
            font-weight: 600; /* Adicionado peso da fonte padr√£o */
        }
        .btn:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300%;
            height: 300%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%);
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.5s ease;
        }
        .btn:hover:before {
            transform: translate(-50%, -50%) scale(1);
        }

        .btn:hover {
            background-color: var(--accent-primary);
            box-shadow: 0 0 25px rgba(56, 189, 248, 0.5);
            transform: translateY(-2px);
        }
        .btn:disabled { background-color: #334155; cursor: not-allowed; transform: none; box-shadow: none; color: #64748b; }

        .btn-red { background-color: #991b1b; border-color: #ef4444; box-shadow: 0 0 15px rgba(239, 68, 68, 0.2); }
        .btn-red:hover { background-color: #b91c1c; box-shadow: 0 0 25px rgba(239, 68, 68, 0.5); }
        .btn-green { background-color: #047857; border-color: #10b981; box-shadow: 0 0 15px rgba(16, 185, 129, 0.2); }
        .btn-green:hover { background-color: #059669; box-shadow: 0 0 25px rgba(16, 185, 129, 0.5); }
        .btn-secondary { background-color: var(--border-color); border-color: #475569; box-shadow: none; }
        .btn-secondary:hover { background-color: #475569; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }

        .nav-link {
            color: var(--text-secondary);
            position: relative;
            transition: all 0.3s ease;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            text-decoration: none;
        }
        .nav-link:before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 0;
            width: 4px;
            background-color: var(--accent-primary);
            border-radius: 0 4px 4px 0;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            background-color: rgba(56, 189, 248, 0.1);
            color: var(--text-primary);
        }
        .nav-link.active {
            background-color: rgba(14, 165, 233, 0.15);
            color: white;
            font-weight: 600;
        }
        .nav-link.active:before {
            height: 60%;
        }

        .modal { display: none; }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            z-index: 50;
            inset: 0;
            background-color: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(8px);
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .animate-fade-in { animation: fadeIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); }

        .table-custom th { color: var(--text-primary); }
        .table-custom th, .table-custom td { padding: 1rem; border-bottom: 1px solid var(--border-color); text-align: left; }
        .table-custom tbody tr:hover { background-color: rgba(30, 41, 59, 0.5); }

        .status-indicator { font-size: 0.75rem; font-weight: 500; padding: 0.25rem 0.6rem; border-radius: 9999px; display: inline-block; margin-left: 0.75rem; vertical-align: middle; }
        .status-indicator.success { background: linear-gradient(to right, rgba(74, 222, 128, 0.1), rgba(16, 185, 129, 0.1)); color: var(--success); border: 1px solid rgba(74, 222, 128, 0.2); }
        .status-indicator.failure { background: linear-gradient(to right, rgba(248, 113, 113, 0.1), rgba(185, 28, 28, 0.1)); color: var(--danger); border: 1px solid rgba(248, 113, 113, 0.2); }
        .status-indicator.unknown { background-color: rgba(100, 116, 139, 0.1); color: #94a3b8; border: 1px solid rgba(100, 116, 139, 0.2); }
        .status-indicator.testing { background: linear-gradient(to right, rgba(56, 189, 248, 0.1), rgba(14, 165, 233, 0.1)); color: #7dd3fc; border: 1px solid rgba(56, 189, 248, 0.2); }

        .tab-button { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 0.5rem 1rem; border-radius: 0.375rem; transition: all 0.3s ease; }
        .tab-button:hover { background-color: var(--bg-secondary); color: var(--text-primary); }
        .tab-button.active { background-color: rgba(14, 165, 233, 0.1); border-color: var(--accent-secondary); color: white; font-weight: 600; box-shadow: 0 0 10px rgba(14, 165, 233, 0.2); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease-out; }

        .progress-bar { background-color: #334155; border-radius: 999px; overflow: hidden; height: 8px; }
        .progress-bar-inner { height: 100%; transition: width 0.5s ease; }

        .metric-card {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
        }
        .metric-card:before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0) 70%);
            transition: transform 0.8s ease;
            transform-origin: center center;
            transform: scale(0);
        }
        .metric-card:hover:before {
            transform: scale(3);
        }

        #app-loader { display: flex; align-items: center; justify-content: center; height: 100vh; font-size: 1.25rem; }

        /* --- CSS ADICIONADO DO CRIADOR DE OFERTAS --- */
        .form-checkbox { accent-color: var(--accent-primary); }
        .btn-danger { background-color: #991b1b; }
        .btn-danger:hover { background-color: #b91c1c; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2); }
        .btn-view { color: var(--text-secondary); }
        .btn-view.active { background-color: var(--accent-secondary); color: white; }

        #preview-wrapper {
            background-color: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            transition: all 0.3s ease-in-out;
            overflow: hidden;
        }
        #preview-wrapper.mobile { max-width: 375px; height: 667px; border: 8px solid #1e293b; }
        #preview-wrapper.desktop { width: 100%; height: 700px; }
        #preview-content {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #888 #f1f1f1;
        }
        #preview-content::-webkit-scrollbar { width: 6px; }
        #preview-content::-webkit-scrollbar-track { background: #f1f1f1; }
        #preview-content::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        #preview-content::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Estilos para a preview da P√°gina de Obrigado */
        #thankYouCreator #preview-wrapper { /* Seletor mais espec√≠fico para a preview da TY page */
            background-color: var(--bg-secondary);
            border-radius: 0.75rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="app-loader">
            <svg class="animate-spin h-8 w-8 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="ml-3">Carregando...</span>
        </div>
    </div>
    <div id="modal-container"></div>

    <script>
    const App = {
        state: {
            API_BASE_URL: 'https://novaapi-one.vercel.app', // Ou seu URL local para testes
            token: null,
            data: {
                pixels: [],
                bots: [],
                pressels: [],
                settings: {},
                transactions: [],
                dashboard: {},
                utmifyIntegrations: [],
                checkouts: []
                // thankYouPages: [], // Poderia adicionar aqui se precisar dos dados em cache
            },
            currentPage: 'dashboard',
            editingCheckoutId: null,
            editingThankYouPageId: null, // <<< ADICIONADO AQUI
            dateFilter: {
                period: 'all',
                startDate: null,
                endDate: null
            },
            revenueChart: null,
        },

        // *** FUN√á√ÉO INIT ATUALIZADA ***
        async init() {
            if (window.location.origin.includes('localhost') || window.location.origin.includes('127.0.0.1')) {
                this.state.API_BASE_URL = 'http://localhost:3000';
            }

            const path = window.location.pathname;
            const origin = window.location.origin;

            // Verifica se a URL √© de uma p√°gina de oferta
            if (path.startsWith('/oferta/')) {
                const checkoutId = path.split('/')[2];
                this.renderCheckoutPage(checkoutId);
                return; // Interrompe a inicializa√ß√£o normal do painel
            }
            // Verifica se a URL √© de uma p√°gina de obrigado
            else if (path.startsWith('/obrigado/')) {
                const pageId = path.split('/')[2];
                // Chama a nova fun√ß√£o para renderizar a p√°gina de obrigado
                this.renderStandaloneThankYouPage(pageId, origin);
                return; // Interrompe a inicializa√ß√£o normal do painel
            }

            // Se n√£o for '/oferta/' nem '/obrigado/', continua com a l√≥gica do painel
            this.state.token = localStorage.getItem('hottrack_token');
            if (this.state.token) {
                try {
                    const [staticData] = await Promise.all([
                        this.apiRequest('/api/dashboard/data'),
                    ]);
                    this.state.data = { ...this.state.data, ...staticData };
                    this.renderLayout();
                    this.navigateTo('dashboard');
                } catch (e) {
                    console.error("Erro ao inicializar:", e);
                    this.logout();
                }
            } else {
                this.renderLogin();
                this.addAuthEventListeners();
            }
        },

        async renderCheckoutPage(checkoutId) {
            const appContainer = document.getElementById('app');
            appContainer.innerHTML = `<div id="app-loader" style="height: 100vh; display: flex; align-items: center; justify-content: center;"><svg class="animate-spin h-8 w-8 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="ml-3">Carregando...</span></div>`;

            try {
                const { config } = await this.apiRequest(`/api/oferta/${checkoutId}`);
                if (!config || !config.pricing || !config.content) {
                     throw new Error("Configura√ß√£o da oferta inv√°lida recebida da API.");
                }

                const formatCurrency = (cents) => (cents / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                const countdownHTML = config.conversion_elements.countdown.enabled
                    ? `<div style="background-color: var(--checkout-accent, #38bdf8); color: white; text-align: center; padding: 0.75rem; position: sticky; top: 0; z-index: 10;">
                           <p style="font-weight: 600; font-size: 0.9rem;">A OFERTA TERMINA EM</p>
                           <p id="countdown-timer" style="font-size: 1.5rem; font-weight: 800; letter-spacing: 0.1em;">--:--</p>
                       </div>`
                    : '';

                const mediaHTML = config.content.media_url
                    ? `<img src="${config.content.media_url}" alt="Preview da Oferta" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 0.5rem; margin-bottom: 1.5rem;">`
                    : '';

                let pricingHTML = '';
                if (config.pricing.type === 'fixed' && Array.isArray(config.pricing.packages)) {
                    pricingHTML = config.pricing.packages.map((pkg, index) => `
                        <div data-package-index="${index}" class="package-item p-4 rounded-lg cursor-pointer hover:border-sky-400 border border-gray-300 bg-white hover:bg-gray-50 transition-all shadow-sm">
                            <h3 class="font-bold text-lg text-gray-900 pointer-events-none">${pkg.title || 'Pacote'}</h3>
                            <p class="text-sm text-gray-600 pointer-events-none">${pkg.description || ''}</p>
                            <p class="text-2xl font-bold mt-2 pointer-events-none" style="color: var(--checkout-accent);">${formatCurrency(pkg.value_cents)}</p>
                        </div>
                    `).join('');
                     pricingHTML = `<div id="packages-list" class="space-y-4 mt-6">${pricingHTML}</div>`;
                } else {
                     pricingHTML = '<p class="text-center text-red-400">Erro na configura√ß√£o de pre√ßos.</p>';
                }

                const orderBumpHTML = config.order_bump.enabled && config.order_bump.product_name
                    ? `<div style="background-color: #fefce8; border: 2px dashed #facc15; padding: 1rem; border-radius: 0.5rem; margin-top: 1.5rem;">
                           <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                               <input id="order-bump-checkbox" type="checkbox" style="width: 1.5rem; height: 1.5rem; margin-top: 0.25rem; accent-color: #ca8a04;">
                               <div>
                                   <h4 style="font-weight: 700; color: #ca8a04;">${config.order_bump.product_name}</h4>
                                   <p style="font-size: 0.9rem; color: #4b5563;">${config.order_bump.description}</p>
                               </div>
                           </div>
                       </div>`
                    : '';

                const guaranteeHTML = config.conversion_elements.guarantee.text
                    ? `<div style="margin-top: 2rem; display: flex; align-items: center; gap: 1rem; background-color: #f9fafb; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
                            ${config.conversion_elements.guarantee.seal_url ? `<img src="${config.conversion_elements.guarantee.seal_url}" alt="Selo de Garantia" style="width: 60px; height: 60px;">` : ''}
                            <div>
                                <h4 style="font-weight: 700; color: #374151;">Garantia Total</h4>
                                <p style="font-size: 0.9rem; color: #6b7280;">${config.conversion_elements.guarantee.text}</p>
                            </div>
                        </div>`
                    : '';

                const testimonials = Array.isArray(config.testimonials) ? config.testimonials : [];
                const testimonialsHTML = testimonials.filter(t => t.name && t.text).length > 0
                    ? `<div style="margin-top: 2.5rem;">
                           <h3 style="font-size: 1.5rem; font-weight: 800; text-align: center; color: var(--checkout-text-primary); margin-bottom: 1.5rem;">O Que Nossos Clientes Dizem</h3>
                           <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                               ${testimonials.map(t => `
                                   <div style="background-color: #f9fafb; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; color: #1f2937;">
                                       <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                           ${t.photo_url ? `<img src="${t.photo_url}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` : ''}
                                           <p style="font-weight: 600; color: #111827;">${t.name}</p>
                                       </div>
                                       <p style="font-size: 0.9rem; color: #4b5563; font-style: italic;">"${t.text}"</p>
                                   </div>
                               `).join('')}
                           </div>
                       </div>`
                    : '';

                const bgColor = config.style.background_color || '#0f172a';
                const accentColor = config.style.accent_color || '#38bdf8';
                const isDarkBg = (parseInt(bgColor.substring(1, 3), 16) * 0.299 + parseInt(bgColor.substring(3, 5), 16) * 0.587 + parseInt(bgColor.substring(5, 7), 16) * 0.114) < 186;
                const primaryTextColor = isDarkBg ? '#f1f5f9' : '#111827';
                const secondaryTextColor = isDarkBg ? '#94a3b8' : '#4b5563';

                const checkoutHTML = `
                    <style>
                        :root {
                            --checkout-bg: ${bgColor};
                            --checkout-accent: ${accentColor};
                            --checkout-text-primary: ${primaryTextColor};
                            --checkout-text-secondary: ${secondaryTextColor};
                        }
                        body, #app {
                            background-color: var(--checkout-bg) !important;
                            font-family: 'Inter', sans-serif;
                            color: var(--checkout-text-primary);
                            height: auto;
                            overflow-y: auto;
                        }
                        .checkout-card {
                            background-color: ${isDarkBg ? 'rgba(30, 41, 59, 0.6)' : 'rgba(255, 255, 255, 0.8)'};
                            border: 1px solid ${isDarkBg ? '#334155' : '#e5e7eb'};
                            backdrop-filter: blur(16px);
                            -webkit-backdrop-filter: blur(16px);
                            color: var(--checkout-text-primary);
                        }
                        .package-item {
                            background-color: ${isDarkBg ? '#1e293b' : '#ffffff'};
                            border-color: ${isDarkBg ? '#334155' : '#e5e7eb'};
                        }
                        .package-item h3 { color: ${isDarkBg ? '#f1f5f9' : '#111827'}; }
                        .package-item p { color: ${isDarkBg ? '#94a3b8' : '#6b7280'}; }
                        .package-item:hover { border-color: var(--checkout-accent); }
                        .package-item.selected {
                            border-color: var(--checkout-accent);
                            box-shadow: 0 0 0 2px var(--checkout-accent);
                        }
                        .final-pay-btn {
                            background-color: var(--checkout-accent);
                            color: ${ (parseInt(accentColor.substring(1, 3), 16) * 0.299 + parseInt(accentColor.substring(3, 5), 16) * 0.587 + parseInt(accentColor.substring(5, 7), 16) * 0.114) < 186 ? '#FFFFFF' : '#000000' };
                            font-weight: 700;
                            padding: 1rem;
                            border-radius: 0.5rem;
                            margin-top: 1.5rem;
                            font-size: 1.1rem;
                            text-transform: uppercase;
                            border: none;
                            width: 100%;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        }
                        .final-pay-btn:hover { filter: brightness(1.1); }
                        .final-pay-btn:disabled { background-color: #334155; color: #64748b; cursor: not-allowed; filter: none; }
                    </style>

                    ${countdownHTML}
                    <div id="checkout-body-wrapper" class="min-h-screen flex items-center justify-center p-4 animate-fade-in">
                        <div class="checkout-card w-full max-w-lg p-6 md:p-8 rounded-2xl shadow-lg">
                            ${mediaHTML}
                            <h1 class="text-2xl font-bold text-center" style="color: var(--checkout-text-primary);">${config.content.main_title || 'Oferta Especial'}</h1>
                            <p style="color: var(--checkout-text-secondary);" class="text-center mb-6">${config.content.subtitle || ''}</p>

                            ${pricingHTML}
                            ${orderBumpHTML}

                            <button id="pay-button" class="final-pay-btn" disabled>Selecione um pacote</button>

                            ${guaranteeHTML}
                            ${testimonialsHTML}
                        </div>
                    </div>
                `;

                appContainer.innerHTML = checkoutHTML;

                if (config.pricing.type === 'fixed' && Array.isArray(config.pricing.packages) && config.pricing.packages.length > 0) {
                    let selectedPackage = null;
                    const packagesList = document.getElementById('packages-list');
                    const payButton = document.getElementById('pay-button');
                    const orderBumpCheckbox = document.getElementById('order-bump-checkbox');

                    function updatePayButtonText() {
                        if (!selectedPackage) return;

                        let totalValue = selectedPackage.value_cents;
                        let buttonText = `Pagar Agora (${formatCurrency(totalValue)})`;

                        if (orderBumpCheckbox && orderBumpCheckbox.checked && config.order_bump && config.order_bump.value_cents > 0) {
                            totalValue += config.order_bump.value_cents;
                            buttonText = `Pagar Agora (${formatCurrency(totalValue)})`;
                        }

                        payButton.textContent = buttonText;
                    }

                    packagesList.addEventListener('click', (e) => {
                        const clickedPackage = e.target.closest('.package-item');
                        if (!clickedPackage) return;

                        packagesList.querySelectorAll('.package-item').forEach(p => p.classList.remove('selected'));
                        clickedPackage.classList.add('selected');

                        const packageIndex = clickedPackage.dataset.packageIndex;
                        selectedPackage = config.pricing.packages[packageIndex];

                        updatePayButtonText();
                        payButton.disabled = false;
                    });

                    if (orderBumpCheckbox) {
                        orderBumpCheckbox.addEventListener('change', updatePayButtonText);
                    }

                    payButton.addEventListener('click', async () => {
                        if (!selectedPackage) { alert('Por favor, selecione um pacote v√°lido.'); return; }

                        let totalValueCents = selectedPackage.value_cents;
                        if (orderBumpCheckbox && orderBumpCheckbox.checked && config.order_bump && config.order_bump.value_cents > 0) {
                            totalValueCents += config.order_bump.value_cents;
                        }

                        payButton.textContent = 'Gerando PIX...';
                        payButton.disabled = true;

                        try {
                            const pixData = await this.apiRequest('/api/oferta/generate-pix', 'POST', {
                                checkoutId: checkoutId,
                                value_cents: totalValueCents
                            });
                            this.showPixModal(pixData);
                        } catch (error) {
                            alert('Erro ao gerar PIX. Tente novamente.');
                        } finally {
                            updatePayButtonText();
                            payButton.disabled = !selectedPackage;
                        }
                    });
                }

                if (config.conversion_elements.countdown.enabled) {
                    const timerEl = document.getElementById('countdown-timer');
                    if (timerEl) {
                        let duration = (config.conversion_elements.countdown.minutes || 15) * 60;
                        const interval = setInterval(() => {
                            const minutes = Math.floor(duration / 60).toString().padStart(2, '0');
                            const seconds = (duration % 60).toString().padStart(2, '0');
                            timerEl.textContent = `${minutes}:${seconds}`;
                            duration--;
                            if (duration < 0) {
                                clearInterval(interval);
                                timerEl.textContent = "00:00";
                            }
                        }, 1000);
                    }
                }

            } catch (error) {
                console.error("Erro ao renderizar p√°gina de checkout:", error);
                appContainer.innerHTML = `<p class="text-center text-red-400 text-lg mt-20">Erro ao carregar oferta: ${error.message || 'Verifique o console.'}</p>`;
            }
        },

        // *** FUN√á√ÉO DE RENDERIZA√á√ÉO DA P√ÅGINA DE OBRIGADO ISOLADA ADICIONADA ***
        async renderStandaloneThankYouPage(pageId, originUrl) {
            const appContainer = document.getElementById('app');
            appContainer.innerHTML = `<div id="app-loader" style="height: 100vh; display: flex; align-items: center; justify-content: center;"><svg class="animate-spin h-8 w-8 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="ml-3">Carregando...</span></div>`;

            try {
                // Busca a configura√ß√£o da p√°gina de obrigado na API
                const { config } = await this.apiRequest(`/api/obrigado/${pageId}`);
                if (!config) {
                    throw new Error("Configura√ß√£o da p√°gina de obrigado n√£o encontrada.");
                }

                // Renderiza o HTML da p√°gina de obrigado
                const thankYouHTML = `
                    <div style="background-color: var(--bg-secondary, #0f172a); color: var(--text-primary, #f1f5f9); font-family: 'Inter', sans-serif; min-height: 100vh; display: flex; align-items: center; justify-content: center; text-align: center; padding: 2rem;">
                        <div class="animate-fade-in">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-400 mx-auto mb-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            <h1 style="font-size: 2.25rem; font-weight: 800; color: white;">${config.main_title || 'Obrigado!'}</h1>
                            <p style="color: var(--text-secondary, #94a3b8); margin-top: 0.5rem; max-width: 450px; margin-left: auto; margin-right: auto;">${config.subtitle || 'Sua compra foi conclu√≠da com sucesso.'}</p>
                            <a id="redirect-button" href="${config.redirect_url || '#'}" style="display: inline-block; background-color: var(--accent-secondary, #0ea5e9); color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.375rem; margin-top: 1.5rem; text-decoration: none; transition: background-color 0.2s ease;">
                                ${config.button_text || 'Acessar Conte√∫do'}
                            </a>
                        </div>
                    </div>
                `;
                appContainer.innerHTML = thankYouHTML;

                // Inicializa o Pixel da Meta
                if (config.pixel_id && config.purchase_value > 0) {
                    if (!document.getElementById('facebook-pixel-script')) {
                        const script = document.createElement('script');
                        script.id = 'facebook-pixel-script';
                        script.innerHTML = `
                            !function(f,b,e,v,n,t,s)
                            {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
                            n.callMethod.apply(n,arguments):n.queue.push(arguments)};
                            if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
                            n.queue=[];t=b.createElement(e);t.async=!0;
                            t.src=v;s=b.getElementsByTagName(e)[0];
                            s.parentNode.insertBefore(t,s)}(window, document,'script',
                            'https://connect.facebook.net/en_US/fbevents.js');
                        `;
                        document.head.appendChild(script);
                    }
                    window.fbq('init', config.pixel_id);
                    window.fbq('track', 'Purchase', {
                        value: config.purchase_value,
                        currency: 'BRL'
                    });
                     console.log(`Pixel ${config.pixel_id} inicializado e evento Purchase disparado.`);
                }

                // Dispara evento para Utmify (via backend)
                if (config.utmify_integration_id) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const trackingParameters = {};
                    ['utm_source', 'utm_medium', 'utm_campaign', 'utm_content', 'utm_term', 'src', 'sck'].forEach(param => {
                        if (urlParams.has(param)) {
                            trackingParameters[param] = urlParams.get(param);
                        }
                    });
                    const customerData = {
                        name: urlParams.get('name') || null,
                        email: urlParams.get('email') || null,
                        phone: urlParams.get('phone') || null
                    };
                    try {
                         // A API Key √© validada no backend com base no pageId, n√£o precisa do token JWT aqui
                         await this.apiRequest('/api/thank-you-pages/fire-utmify', 'POST', {
                            pageId: pageId,
                            trackingParameters: trackingParameters,
                            customerData: customerData
                         });
                         console.log("Evento Utmify disparado (via backend).");
                    } catch (utmifyError) {
                        console.error("Erro ao disparar evento Utmify via backend:", utmifyError);
                    }
                }

            } catch (error) {
                console.error("Erro ao renderizar p√°gina de obrigado:", error);
                appContainer.innerHTML = `<p class="text-center text-red-400 text-lg mt-20">Erro ao carregar p√°gina: ${error.message || 'Verifique o console.'}</p>`;
            }
        },

        showPixModal(pixData) {
            const modalContent = `
                <div class="text-center">
                    <h3 class="text-lg font-bold text-green-400">PIX Gerado com Sucesso!</h3>
                    <p class="text-sm text-gray-400 mt-2 mb-4">Copie o c√≥digo abaixo e pague no seu aplicativo do banco.</p>
                    <textarea id="pix-code-textarea" class="form-input w-full p-2 font-mono text-xs bg-slate-900" rows="5" readonly>${pixData.qr_code_text || 'Erro ao obter c√≥digo'}</textarea>
                    <button id="copy-pix-btn" class="btn w-full mt-4 py-2">Copiar C√≥digo PIX</button>
                </div>
            `;
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = this.templates.modal('Pagamento via PIX', modalContent);

            const copyBtn = document.getElementById('copy-pix-btn');
            if (copyBtn) {
                copyBtn.addEventListener('click', (e) => {
                    const textarea = document.getElementById('pix-code-textarea');
                    if (textarea && textarea.value !== 'Erro ao obter c√≥digo') {
                        textarea.select();
                        try {
                           document.execCommand('copy');
                           e.target.textContent = 'Copiado!';
                           setTimeout(() => { e.target.textContent = 'Copiar C√≥digo PIX'; }, 2000);
                        } catch (err) {
                           console.error('Falha ao copiar:', err);
                           alert('N√£o foi poss√≠vel copiar o c√≥digo. Selecione e copie manualmente.');
                        }
                    } else {
                        alert('N√£o h√° c√≥digo PIX para copiar.');
                    }
                });
            }
        },

        renderLogin(page = 'login') {
            document.getElementById('app').innerHTML = this.templates.auth(page);
        },

        renderLayout() {
            document.getElementById('app').innerHTML = this.templates.layout();
            this.addDashboardEventListeners();
        },

        formatNumber(number, isCurrency = false) {
            if (typeof number !== 'number') {
                number = parseFloat(number) || 0;
            }
            if (isCurrency) {
                return (number / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            } else {
                return number.toLocaleString('pt-BR');
            }
        },

        templates: {
            auth(page = 'login') {
                return `<div class="flex items-center justify-center min-h-screen p-4">${page === 'login' ? this.loginForm() : this.registerForm()}</div>`;
            },
            loginForm() {
                return `
                <div class="card p-8 rounded-2xl shadow-lg w-full max-w-md animate-fade-in">
                    <div class="text-center mb-8">
                        <div class="flex items-center justify-center gap-2">
                            <svg class="h-10 w-10 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
                            <h1 class="text-4xl font-bold text-white">HotTrack</h1>
                        </div>
                        <p class="text-slate-400 mt-2">Acesse sua conta para continuar.</p>
                    </div>
                    <form id="loginForm" class="space-y-6">
                        <div><label class="text-sm font-medium text-gray-400 mb-1 block">E-mail</label><input name="email" type="email" required class="form-input w-full p-3"></div>
                        <div><label class="text-sm font-medium text-gray-400 mb-1 block">Senha</label><input name="password" type="password" required class="form-input w-full p-3"></div>
                        <button type="submit" class="btn w-full font-semibold py-3 rounded-md">Entrar na Plataforma</button>
                    </form>
                    <div class="text-center mt-6"><a href="#" id="showRegister" class="text-sm text-sky-400 hover:text-sky-300 hover:underline">N√£o tem uma conta? Cadastre-se agora</a></div>
                </div>`;
            },
            registerForm() {
                return `
                <div class="card p-8 rounded-2xl shadow-lg w-full max-w-md animate-fade-in">
                     <div class="text-center mb-8">
                        <div class="flex items-center justify-center gap-2">
                            <svg class="h-10 w-10 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
                            <h1 class="text-4xl font-bold text-white">HotTrack</h1>
                        </div>
                        <p class="text-slate-400 mt-2">Crie sua conta e comece a rastrear.</p>
                    </div>
                    <form id="registerForm" class="space-y-4">
                        <div><label class="text-sm font-medium text-gray-400 mb-1 block">Nome</label><input name="name" type="text" required class="form-input w-full p-3"></div>
                        <div><label class="text-sm font-medium text-gray-400 mb-1 block">E-mail</label><input name="email" type="email" required class="form-input w-full p-3"></div>
                        <div><label class="text-sm font-medium text-gray-400 mb-1 block">Senha (m√≠nimo 8 caracteres)</label><input name="password" type="password" required minlength="8" class="form-input w-full p-3"></div>
                        <button type="submit" class="btn w-full font-semibold py-3 rounded-md">Criar Minha Conta</button>
                    </form>
                    <div class="text-center mt-6"><a href="#" id="showLogin" class="text-sm text-sky-400 hover:text-sky-300 hover:underline">J√° tem uma conta? Fa√ßa Login</a></div>
                </div>`;
            },
            layout() {
                return `
                <div class="relative min-h-screen md:flex">
                    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-20 md:hidden hidden"></div>

                    <aside id="sidebar" class="w-64 bg-slate-900/80 backdrop-blur-lg p-4 flex-col fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-30 border-r border-slate-800 flex">
                        <div class="text-center py-4 mb-6 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <svg class="h-8 w-8 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
                                <h1 class="text-2xl font-bold text-white">HotTrack</h1>
                            </div>
                            <button id="close-sidebar-btn" class="md:hidden text-gray-400 text-3xl hover:text-white">&times;</button>
                        </div>
                        <nav id="sidebarNav" class="flex-grow flex flex-col space-y-1">
                            <div data-target="dashboard" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>Dashboard</div>
                            <a href="/hotbot/" target="_blank" class="nav-link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                </svg>
                                <span>HotBot</span>
                            </a>
                            <div data-target="bots" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M11 17a1 1 0 001.447.894l4-2A1 1 0 0017 15V5a1 1 0 00-1.447-.894l-4 2A1 1 0 0011 7v10zM4 17a1 1 0 001.447.894l4-2A1 1 0 0010 15V5a1 1 0 00-1.447-.894l-4 2A1 1 0 004 7v10z" /></svg>Gerenciar Bots</div>
                            <div data-target="pressels" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>Criador de Pressel</div>

                            <div data-target="checkouts" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1H2V6z" clip-rule="evenodd" /><path d="M2 12a2 2 0 012-2h12a2 2 0 012 2v2a2 2 0 01-2 2H4a2 2 0 01-2-2v-2z" /></svg>Meus Checkouts</div>
                            <div data-target="pageCreator" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>Criar Novo Checkout</div>

                            {/* */}
                            <div data-target="thankYouCreator" class="nav-link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                                <span>Criar P√°g. Obrigado</span>
                            </div>
                            <div data-target="thankYouPages" class="nav-link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                                </svg>
                                <span>Minhas P√°gs. Obrigado</span>
                            </div>
                            {/* */}

                            <div data-target="pixels" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h10a3 3 0 013 3v5a.997.997 0 01-.293-.707zM5 4a1 1 0 00-1 1v.01L8 9.01l4-4.002V5a1 1 0 00-1-1H5z" clip-rule="evenodd" /></svg>Gerenciar Pixels</div>
                            <div data-target="transactions" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8.433 7.418c.158-.103.346-.196.567-.267v1.698a2.5 2.5 0 00-1.168-.217c-.165 0-.33.018-.488.054a1 1 0 01-.502 1.765l.986.328c.73.243 1.196.96 1.196 1.765 0 1.132-.98 1.99-2.206 1.99-1.225 0-2.205-.858-2.205-1.99 0-.962.63-1.698 1.447-1.938l.986-.329a1 1 0 01.502-1.765z" /><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.5 4.5 0 00-1.838.385l-.234-.14a1 1 0 00-1.18.157l-1 1.732a1 1 0 00.157 1.18l.234.14A4.5 4.5 0 005.5 8.5v.092l-1.07.356a1 1 0 00-.503 1.765l.986.329a2.5 2.5 0 001.09.243v.092a4.5 4.5 0 001.838-.385l.234.14a1 1 0 001.18-.157l1-1.732a1 1 0 00-.157-1.18l-.234-.14a4.5 4.5 0 001.03-2.062V5z" clip-rule="evenodd" /></svg>Transa√ß√µes</div>
                            <div class="h-px bg-slate-700 my-2"></div>
                            <div data-target="settings" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z" /></svg>API PIX</div>
                            <div data-target="integrations" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0l-1.5-1.5a2 2 0 112.828-2.828l1.5 1.5z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M6.414 11.586a2 2 0 10-2.828 2.828l3 3a2 2 0 002.828 0l1.5-1.5a2 2 0 10-2.828-2.828l-1.5 1.5z" clip-rule="evenodd" /></svg>Integra√ß√µes</div>
                            <div data-target="documentation" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>API & Docs</div>
                            <a href="https://wa.me/5541995211148" target="_blank" class="nav-link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 8a7 7 0 110-14 7 7 0 010 14zm-1-11a1 1 0 100 2h2a1 1 0 100-2H9z" clip-rule="evenodd" /></svg>
                                <span>Suporte</span>
                            </a>
                        </nav>
                        <div class="mt-auto"><button id="logoutButton" class="w-full text-slate-400 hover:bg-red-900/50 hover:text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-all duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" /></svg>Sair da Conta</button></div>
                    </aside>

                    <div class="flex-1 flex flex-col w-full h-full"> <header class="p-4 md:hidden card flex justify-between items-center sticky top-0 z-10 flex-shrink-0"> <button id="open-sidebar-btn" class="text-white">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                             </button>
                             <div class="text-lg font-bold">HotTrack</div>
                        </header>
                        <main id="content" class="flex-1 overflow-y-auto"></main>
                    </div>
                </div>`;
            },
            dateFilterComponent(page) {
                const { period } = App.state.dateFilter;
                const btnClasses = "btn-secondary py-1 px-3 rounded-md text-xs";
                const activeClasses = "active !bg-sky-500 !border-sky-400 !text-white";
                return `
                <div id="${page}-date-filter" class="card p-3 rounded-lg mb-6 flex flex-wrap items-center gap-2 text-sm">
                    <span class="font-semibold mr-2 text-slate-300">Per√≠odo:</span>
                    <button data-period="today" class="${btnClasses} ${period === 'today' ? activeClasses : ''}">Hoje</button>
                    <button data-period="yesterday" class="${btnClasses} ${period === 'yesterday' ? activeClasses : ''}">Ontem</button>
                    <button data-period="last7days" class="${btnClasses} ${period === 'last7days' ? activeClasses : ''}">7 Dias</button>
                    <button data-period="thisMonth" class="${btnClasses} ${period === 'thisMonth' ? activeClasses : ''}">Este M√™s</button>
                    <div class="flex items-center gap-2 pl-4 border-l border-slate-700 ml-2">
                         <input type="date" id="${page}-start-date" class="form-date p-1 rounded-md text-xs">
                         <span class="text-gray-500">at√©</span>
                         <input type="date" id="${page}-end-date" class="form-date p-1 rounded-md text-xs">
                         <button id="apply-custom-date-filter-${page}" class="btn-secondary py-1 px-3 rounded-md text-xs">Filtrar</button>
                    </div>
                    <button id="clear-date-filter-${page}" class="btn-secondary py-1 px-3 rounded-md ml-auto text-xs">Limpar Filtro</button>
                </div>`;
            },
            dashboard() {
                return `
                <div class="animate-fade-in p-4 md:p-8"> <div class="mb-6">
                        <h1 class="text-3xl font-bold text-white">Painel de M√©tricas</h1>
                        <p class="text-slate-400">Vis√£o geral do desempenho de suas opera√ß√µes.</p>
                    </div>
                    ${this.dateFilterComponent('dashboard')}
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                        <div class="card metric-card"><h3 class="text-sm text-gray-400">Cliques na P√°gina</h3><p id="metric-clicks" class="text-4xl font-bold text-sky-400 mt-2">...</p></div>
                        <div class="card metric-card"><h3 class="text-sm text-gray-400">PIX Gerados</h3><p id="metric-generated" class="text-4xl font-bold text-yellow-400 mt-2">...</p></div>
                        <div class="card metric-card"><h3 class="text-sm text-gray-400">Faturamento Total</h3><p id="metric-total-revenue" class="text-4xl font-bold text-sky-400 mt-2">...</p></div>
                        <div class="card metric-card"><h3 class="text-sm text-gray-400">PIX Pagos</h3><p id="metric-paid" class="text-4xl font-bold text-green-400 mt-2">...</p></div>
                        <div class="card metric-card"><h3 class="text-sm text-gray-400">Faturamento Pago</h3><p id="metric-paid-revenue" class="text-4xl font-bold text-green-400 mt-2">...</p></div>
                    </div>
                    <div class="card p-6 rounded-lg mb-8">
                        <h2 class="text-xl font-semibold text-white mb-4">Desempenho de Faturamento</h2>
                        <div class="relative h-96"> <canvas id="revenueChart"></canvas> </div>
                    </div>
                    <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
                        <div class="card p-6 rounded-lg lg:col-span-2"><h2 class="text-xl font-semibold text-white mb-4">Desempenho por Bot</h2><div id="bots-performance-table-container" class="overflow-x-auto"><table class="table-custom w-full text-sm"><thead><tr><th>Bot</th><th>Cliques</th><th>Vendas</th><th>Faturamento</th></tr></thead><tbody id="bots-performance-table"><tr><td colspan="4">Carregando...</td></tr></tbody></table></div></div>
                        <div class="card p-6 rounded-lg"><h2 class="text-xl font-semibold text-white mb-4">Tr√°fego por Estado</h2><div id="traffic-by-state-table-container" class="overflow-x-auto"><table class="table-custom w-full text-sm"><thead><tr><th>Estado</th><th>Cliques</th></tr></thead><tbody id="traffic-by-state-table"><tr><td colspan="2">Carregando...</td></tr></tbody></table></div></div>
                    </div>
                     <div class="grid grid-cols-1 gap-8 lg:grid-cols-3 mt-8">
                        <div class="card p-6 rounded-lg lg:col-span-2">
                             <h2 class="text-xl font-semibold text-white mb-4">Minhas Conquistas</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="achievements-list">
                                <p class="text-gray-500 text-sm">Carregando conquistas...</p>
                            </div>
                        </div>
                         <div class="card p-6 rounded-lg">
                            <h2 class="text-xl font-semibold text-white mb-4">Ranking de Vendas</h2>
                            <div id="ranking-list" class="space-y-2">
                                <p class="text-gray-500 text-sm">Carregando ranking...</p>
                            </div>
                            <p id="user-rank-status" class="mt-4 text-center text-sm font-medium text-sky-400"></p>
                        </div>
                    </div>
                </div>`;
            },
            checkouts() {
                return `
                <div class="animate-fade-in p-4 md:p-8"> <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div>
                            <h1 class="text-3xl font-bold text-white">Meus Checkouts</h1>
                            <p class="text-slate-400">Gerencie suas p√°ginas de oferta criadas.</p>
                        </div>
                        <button id="go-to-creator-btn" class="btn">Criar Novo Checkout</button>
                    </div>
                    <div class="card p-0 md:p-6 rounded-lg">
                        <div id="checkouts-table-container" class="overflow-x-auto">
                            <table class="table-custom w-full text-sm">
                                <thead>
                                    <tr>
                                        <th>Nome da Oferta</th>
                                        <th>Data de Cria√ß√£o</th>
                                        <th class="text-right">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="checkouts-table-body">
                                    <tr><td colspan="3" class="text-center text-gray-500 py-8">Carregando checkouts...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            },
            pageCreator() {
                 return `
                <div id="creator-screen" class="animate-fade-in flex flex-col h-full">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 flex-shrink-0 p-4 md:p-8 pb-0">
                        <div>
                            <h1 id="creator-title" class="text-3xl font-bold text-white">Criador de Ofertas</h1>
                            <p class="text-slate-400 mt-1">Configure √† esquerda e veja o resultado √† direita em tempo real.</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <button type="button" id="back-to-checkouts-btn" class="btn btn-secondary">Cancelar</button>
                            <button type="submit" form="checkout-form" id="submit-btn" class="btn font-bold text-lg py-2 px-6">Criar Checkout</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 flex-1 overflow-hidden p-4 md:p-8 pt-0">

                        <form id="checkout-form" class="space-y-6 overflow-y-auto pr-4">
                            <div class="card p-6 rounded-xl">
                                <h2 class="text-xl font-semibold mb-4 border-b border-slate-700 pb-2">1. Conte√∫do da P√°gina</h2>
                                <div class="space-y-4">
                                    <div><label for="main_title" class="text-sm font-medium text-gray-400 mb-1 block">T√≠tulo Principal</label><input id="main_title" type="text" class="form-input w-full p-2" value="Desbloqueie o Segredo Para um Corpo Definido" required></div>
                                    <div><label for="subtitle" class="text-sm font-medium text-gray-400 mb-1 block">Subt√≠tulo</label><input id="subtitle" type="text" class="form-input w-full p-2" value="Acesso exclusivo por tempo limitado √† metodologia que j√° transformou 5.000+ vidas." required></div>
                                    <div><label for="media_url" class="text-sm font-medium text-gray-400 mb-1 block">URL da Imagem/V√≠deo (Opcional)</label><input id="media_url" type="url" class="form-input w-full p-2" placeholder="https://exemplo.com/imagem.png"></div>
                                </div>
                            </div>
                            <div class="card p-6 rounded-xl">
                                <h2 class="text-xl font-semibold mb-4 border-b border-slate-700 pb-2">2. Pre√ßos</h2>
                                <div class="mb-4">
                                    <label for="pricing-type-select" class="text-sm font-medium text-gray-400 mb-1 block">Modelo de Pre√ßo</label>
                                    <select id="pricing-type-select" class="form-select w-full p-2">
                                        <option value="fixed">Pacotes com Pre√ßo Fixo</option>
                                        <option value="open" disabled>Valor Aberto (Em breve)</option>
                                    </select>
                                </div>
                                <div id="fixed-pricing-container">
                                    <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-medium">Pacotes de Pre√ßos</h3><button type="button" id="add-package-btn" class="btn btn-secondary text-sm py-1 px-3">+ Pacote</button></div>
                                    <div id="packages-container" class="space-y-4"></div>
                                </div>
                                <div id="open-pricing-container" class="hidden space-y-4">
                                    {/* Conte√∫do do valor aberto... */}
                                </div>
                            </div>
                            <div class="card p-6 rounded-xl">
                                <h2 class="text-xl font-semibold mb-4 border-b border-slate-700 pb-2">3. Order Bump (Opcional)</h2>
                                <div class="flex items-center space-x-3 mb-4"><input id="enable_order_bump" type="checkbox" class="form-checkbox h-5 w-5 rounded"><label for="enable_order_bump" class="font-medium">Ativar Order Bump</label></div>
                                <div id="order-bump-fields" class="hidden space-y-4">
                                    <div><label for="order_bump_product_name" class="text-sm font-medium text-gray-400 mb-1 block">Nome do Produto</label><input id="order_bump_product_name" type="text" class="form-input w-full p-2" value="Ebook de Receitas Fit"></div>
                                    <div><label for="order_bump_description" class="text-sm font-medium text-gray-400 mb-1 block">Descri√ß√£o da Oferta</label><input id="order_bump_description" type="text" class="form-input w-full p-2" value="SIM! Quero adicionar o guia completo por apenas R$9,90!"></div>
                                    <div><label for="order_bump_value" class="text-sm font-medium text-gray-400 mb-1 block">Valor (R$)</label><input id="order_bump_value" type="number" step="0.01" min="0" class="form-input w-full p-2" value="9.90"></div>
                                </div>
                            </div>
                            <div class="card p-6 rounded-xl">
                                <h2 class="text-xl font-semibold mb-4 border-b border-slate-700 pb-2">4. Elementos de Convers√£o</h2>
                                <div class="space-y-6">
                                    <div>
                                        <div class="flex items-center space-x-3 mb-2"><input id="enable_countdown" type="checkbox" class="form-checkbox h-5 w-5 rounded"><label for="enable_countdown" class="font-medium">Ativar Contador Regressivo</label></div>
                                        <div id="countdown-fields" class="hidden"><label for="countdown_minutes" class="text-sm font-medium text-gray-400 mb-1 block">Dura√ß√£o em Minutos</label><input id="countdown_minutes" type="number" min="1" class="form-input w-full max-w-xs p-2" value="15"></div>
                                    </div>
                                    <div>
                                        <h3 class="font-medium mb-2">Selo de Garantia</h3>
                                        <div class="space-y-4">
                                            <div><label for="guarantee_text" class="text-sm font-medium text-gray-400 mb-1 block">Texto da Garantia</label><textarea id="guarantee_text" class="form-textarea w-full p-2" rows="3">Sua satisfa√ß√£o garantida ou seu dinheiro de volta em 7 dias. Risco zero!</textarea></div>
                                            <div><label for="guarantee_seal_url" class="text-sm font-medium text-gray-400 mb-1 block">URL da Imagem do Selo (Opcional)</label><input id="guarantee_seal_url" type="url" class="form-input w-full p-2" placeholder="https://exemplo.com/selo.png"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card p-6 rounded-xl">
                                <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2"><h2 class="text-xl font-semibold">5. Prova Social</h2><button type="button" id="add-testimonial-btn" class="btn btn-secondary text-sm py-1 px-3">+ Depoimento</button></div>
                                <div id="testimonials-container" class="space-y-4"></div>
                            </div>
                            <div class="card p-6 rounded-xl">
                                <h2 class="text-xl font-semibold mb-4 border-b border-slate-700 pb-2">6. Rastreamento e Estilo</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="pixel_id" class="text-sm font-medium text-gray-400 mb-1 block">Pixel da Meta</label>
                                        <select id="pixel_id" class="form-select w-full p-2" required>
                                            <option value="">-- Selecione um Pixel --</option>
                                            </select>
                                    </div>
                                    <div>
                                        <label for="utmify_integration_id" class="text-sm font-medium text-gray-400 mb-1 block">Integra√ß√£o Utmify (Opcional)</label>
                                        <select id="utmify_integration_id" class="form-select w-full p-2">
                                            <option value="">-- Nenhuma --</option>
                                        </select>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <div><label for="background_color" class="text-sm font-medium text-gray-400 mb-1 block">Fundo</label><input id="background_color" type="color" value="#0f172a" class="form-input h-10 w-16 p-1"></div>
                                        <div><label for="accent_color" class="text-sm font-medium text-gray-400 mb-1 block">Destaque</label><input id="accent_color" type="color" value="#38bdf8" class="form-input h-10 w-16 p-1"></div>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <div class="relative h-full">
                            <div class="sticky top-0">
                                <div class="flex justify-center items-center gap-2 mb-4">
                                    <div class="flex rounded-lg bg-slate-700 p-1">
                                        <button id="desktop-view-btn" class="btn-view active px-3 py-1 text-xs rounded-md">Desktop</button>
                                        <button id="mobile-view-btn" class="btn-view px-3 py-1 text-xs rounded-md">Mobile</button>
                                    </div>
                                </div>
                                <div id="preview-wrapper" class="desktop mx-auto">
                                    <div id="preview-content"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* */}
                    <div id="result-screen" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center animate-fade-in z-50 p-4">
                        <div class="card p-8 rounded-2xl w-full max-w-2xl mx-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-center text-green-400">Checkout Criado com Sucesso!</h2>
                                <button id="closeModalBtn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
                            </div>
                            <p class="text-slate-400 text-center mt-2 mb-6">Este √© o link <span class="font-bold text-white">√∫nico e exclusivo</span> da sua nova p√°gina de oferta. Guarde-o e use-o em suas campanhas.</p>
                            <div class="bg-slate-900 p-4 rounded-lg flex items-center gap-4">
                                <input id="checkout-link-output" type="text" class="form-input flex-grow bg-transparent border-0" readonly>
                                <button id="copy-link-btn" class="btn btn-secondary text-sm py-2 px-4 whitespace-nowrap">Copiar Link</button>
                            </div>
                            <div class="text-center mt-6">
                                <button id="create-another-btn" class="btn text-sm py-2 px-5">Ver Meus Checkouts</button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            },

            thankYouCreator() {
                return `
                <div id="creator-screen" class="animate-fade-in p-4 md:p-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div>
                            {/* */}
                            <h1 class="text-3xl font-bold text-white">Criador de P√°gina de Obrigado</h1>
                            <p class="text-slate-400 mt-1">Gere links para disparar eventos de compra no navegador.</p>
                        </div>
                        <div class="flex items-center gap-4">
                            {/* */}
                            <button type="button" id="back-to-ty-list-btn" class="btn btn-secondary">Cancelar</button>
                            {/* */}
                            <button type="submit" form="thank-you-form" id="submit-btn" class="btn font-bold text-lg py-2 px-6">Gerar P√°gina</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <form id="thank-you-form" class="space-y-6">
                            <div class="card p-6 rounded-xl">
                                <h2 class="text-xl font-semibold mb-4 border-b border-slate-700 pb-2">1. Configura√ß√µes da P√°gina</h2>
                                <div class="space-y-4">
                                    <input id="page_name" type="text" class="form-input w-full p-2" placeholder="Nome da P√°gina (Ex: Compra Ebook X)" required>
                                    <input id="main_title" type="text" class="form-input w-full p-2" placeholder="T√≠tulo (Ex: Obrigado pela sua compra!)" value="Obrigado pela sua compra!" required>
                                    <input id="subtitle" type="text" class="form-input w-full p-2" placeholder="Subt√≠tulo (Ex: Clique abaixo para acessar)" value="Seu acesso foi enviado para seu email. Clique no bot√£o abaixo para ir para a √°rea de membros." required>
                                    <div class="grid grid-cols-2 gap-4">
                                        <input id="button_text" type="text" class="form-input w-full p-2" placeholder="Texto do Bot√£o" value="Acessar Conte√∫do" required>
                                        <input id="redirect_url" type="url" class="form-input w-full p-2" placeholder="URL de Redirecionamento" required>
                                    </div>
                                </div>
                            </div>

                            <div class="card p-6 rounded-xl">
                                <h2 class="text-xl font-semibold mb-4 border-b border-slate-700 pb-2">2. Configura√ß√µes de Convers√£o</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="purchase_value" class="text-sm font-medium text-gray-400 mb-1 block">Valor da Compra (R$)</label>
                                        <input id="purchase_value" type="number" step="0.01" min="0" class="form-input w-full p-2" placeholder="97.90" required>
                                    </div>
                                    <div>
                                        <label for="pixel_id" class="text-sm font-medium text-gray-400 mb-1 block">ID do Pixel da Meta</label>
                                        <input id="pixel_id" type="text" class="form-input w-full p-2" placeholder="Cole o ID do seu Pixel" required>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="utmify_integration_id" class="text-sm font-medium text-gray-400 mb-1 block">Enviar evento para Utmify (Opcional)</label>
                                        <select id="utmify_integration_id" class="form-select w-full p-2">
                                            <option value="">N√£o enviar</option>
                                            {/* */}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <div class="sticky top-8">
                            <h3 class="text-lg font-semibold text-center mb-4">Visualiza√ß√£o</h3>
                            <div id="preview-wrapper" class="w-full h-[500px]">
                                <div id="preview-content"></div>
                            </div>
                        </div>
                    </div>

                    <div id="result-screen" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center animate-fade-in z-50 p-4">
                        <div class="card p-8 rounded-2xl w-full max-w-2xl mx-auto">
                            {/* */}
                             <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-center text-green-400">P√°gina Criada com Sucesso!</h2>
                                <button id="closeModalBtn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
                            </div>
                            <p class="text-slate-400 text-center mt-2 mb-6">Use este link como a URL de obrigado na sua plataforma de pagamento.</p>
                            <div class="bg-slate-900 p-4 rounded-lg flex items-center gap-4">
                                <input id="page-link-output" type="text" class="form-input flex-grow bg-transparent border-0" readonly>
                                <button id="copy-link-btn" class="btn btn-secondary text-sm py-2 px-4 whitespace-nowrap">Copiar Link</button>
                            </div>
                            <div class="text-center mt-6">
                                <button id="create-another-btn" class="btn text-sm py-2 px-5">Criar Outra P√°gina</button>
                                <button id="view-ty-pages-btn" class="btn btn-secondary text-sm py-2 px-5 ml-2">Ver Minhas P√°ginas</button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            },

            // *** TEMPLATE DA LISTAGEM DE P√ÅGINAS DE OBRIGADO ***
            thankYouPages() {
                return `
                <div class="animate-fade-in p-4 md:p-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div>
                            <h1 class="text-3xl font-bold text-white">Minhas P√°ginas de Obrigado</h1>
                            <p class="text-slate-400">Gerencie suas p√°ginas de obrigado criadas.</p>
                        </div>
                        <button id="go-to-thankyou-creator-btn" class="btn">Criar Nova P√°gina</button>
                    </div>
                    <div class="card p-0 md:p-6 rounded-lg">
                        <div id="thankyou-table-container" class="overflow-x-auto">
                            <table class="table-custom w-full text-sm">
                                <thead>
                                    <tr>
                                        <th>Nome da P√°gina</th>
                                        <th>Data de Cria√ß√£o</th>
                                        <th class="text-right">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="thankyou-table-body">
                                    <tr><td colspan="3" class="text-center text-gray-500 py-8">Carregando p√°ginas...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            },

            pixels() {
                const pixelListHTML = App.state.data.pixels.map(p => `<div class="p-3 bg-slate-900/50 rounded-lg flex justify-between items-center"><span class="font-mono text-sm">${p.account_name}</span><button data-id="${p.id}" class="delete-pixel-btn btn btn-red text-xs py-1 px-2">Excluir</button></div>`).join('');
                return `
                <div class="animate-fade-in p-4 md:p-8"> <div class="mb-6"><h1 class="text-3xl font-bold text-white">Gerenciar Pixels</h1><p class="text-slate-400">Adicione e gerencie seus pixels do Facebook.</p></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="card p-6 rounded-lg">
                            <h2 class="text-xl font-semibold mb-4 text-white">Adicionar Novo Pixel</h2>
                            <form id="pixelForm" class="space-y-4"><input name="account_name" placeholder="Nome do Pixel (Ex: Produto Y)" class="form-input w-full p-2" required><input name="pixel_id" placeholder="ID do Pixel da Meta" class="form-input w-full p-2" required><textarea name="meta_api_token" placeholder="Token da API de Convers√µes" class="form-input w-full p-2" rows="3" required></textarea><button type="submit" class="btn w-full p-2 rounded-md">Adicionar Pixel</button></form>
                        </div>
                        <div class="card p-6 rounded-lg"><h2 class="text-xl font-semibold text-white mb-4">Pixels Salvos</h2><div id="pixel-list" class="space-y-3 max-h-96 overflow-y-auto">${pixelListHTML.length ? pixelListHTML : '<p class="text-gray-500 text-sm">Nenhum pixel salvo.</p>'}</div></div>
                    </div>
                </div>`;
            },
            bots() {
                 const botListHTML = App.state.data.bots.map(b => `
                    <div class="p-3 bg-slate-900/50 rounded-lg flex justify-between items-center">
                        <div>
                            <span class="text-sm font-medium">${b.bot_name}</span>
                            <span id="status-indicator-bot-${b.id}"></span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button data-id="${b.id}" class="delete-bot-btn btn btn-red text-xs py-1 px-2">Excluir</button>
                        </div>
                    </div>`).join('');
                return `
                <div class="animate-fade-in p-4 md:p-8"> <div class="mb-6"><h1 class="text-3xl font-bold text-white">Gerenciar Bots</h1><p class="text-slate-400">Conecte seus bots do Telegram para automatizar processos.</p></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="card p-6 rounded-lg">
                            <h2 class="text-xl font-semibold mb-4 text-white">Adicionar Novo Bot</h2>
                            <form id="botForm" class="space-y-4">
                                <input name="bot_name" placeholder="Username do Bot (sem @)" class="form-input w-full p-2" required>
                                <button type="submit" class="btn w-full p-2 rounded-md">Adicionar Bot</button>
                            </form>
                        </div>
                        <div class="card p-6 rounded-lg"><h2 class="text-xl font-semibold text-white mb-4">Bots Salvos</h2><div id="bot-list" class="space-y-3 max-h-96 overflow-y-auto">${botListHTML.length ? botListHTML : '<p class="text-gray-500 text-sm">Nenhum bot salvo.</p>'}</div></div>
                    </div>
                </div>`;
            },
            pressels() {
                const { pixels, bots, pressels, utmifyIntegrations } = App.state.data;
                const botOptions = bots.map(b => `<option value="${b.id}">${b.bot_name}</option>`).join('');
                const utmifyOptions = utmifyIntegrations.map(u => `<option value="${u.id}">${u.account_name}</option>`).join('');
                const pixelCheckboxes = pixels.map(p => `<label class="flex items-center space-x-2 text-gray-300 hover:text-white cursor-pointer p-2 rounded-md hover:bg-slate-700/50"><input type="checkbox" name="pixel_ids" value="${p.id}" class="h-4 w-4 bg-slate-700 border-slate-500 rounded text-sky-500 focus:ring-sky-500"><span>${p.account_name}</span></label>`).join('');
                const presselList = pressels.map(pr => `<div class="p-3 card flex justify-between items-center text-sm"><div><p class="font-semibold">${pr.name}</p><p class="text-xs text-gray-400">Bot: ${pr.bot_name}</p></div><div class="space-x-2"><button data-id="${pr.id}" class="generate-pressel-code-btn btn text-xs py-1 px-2">Ver C√≥digo</button><button data-id="${pr.id}" class="delete-pressel-btn btn btn-red text-xs py-1 px-2">Excluir</button></div></div>`).join('');

                return `
                <div class="animate-fade-in p-4 md:p-8"> <div class="mb-6"><h1 class="text-3xl font-bold text-white">Criador de Pressel</h1><p class="text-slate-400">Configure suas p√°ginas de pressel para captura de leads.</p></div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="card p-6 rounded-lg">
                            <h2 class="text-xl font-bold mb-4 text-white">Criar Nova Pressel</h2>
                            <form id="presselForm" class="space-y-4">
                                <input name="name" placeholder="Nome da Pressel (Ex: Campanha Black Friday)" class="form-input w-full p-2" required>
                                <input name="white_page_url" type="url" placeholder="URL da P√°gina Branca" class="form-input w-full p-2" required>
                                <select name="bot_id" class="form-select w-full p-2" required><option value="">Selecione um Bot</option>${botOptions}</select>

                                <div>
                                    <label class="text-sm font-medium text-gray-400 mb-1 block">Enviar Eventos para Utmify (Opcional)</label>
                                    <select name="utmify_integration_id" class="form-select w-full p-2">
                                        <option value="">N√£o enviar</option>
                                        ${utmifyOptions}
                                    </select>
                                </div>

                                <div class="card p-3"><p class="font-semibold mb-2">Selecione os Pixels:</p><div class="space-y-1">${pixelCheckboxes.length ? pixelCheckboxes : '<p class="text-gray-500 text-sm">Cadastre um pixel primeiro.</p>'}</div></div>
                                <button type="submit" class="btn w-full p-3 rounded-md text-base font-bold">Salvar e Gerar C√≥digo</button>
                            </form>
                        </div>
                        <div class="card p-6 rounded-lg"><h2 class="text-xl font-bold mb-4 text-white">Pressels Criadas</h2><div id="pressel-list" class="space-y-3">${presselList.length ? presselList : '<p class="text-gray-500 text-sm">Nenhuma pressel criada.</p>'}</div></div>
                    </div>
                </div>`;
            },
            transactions() {
                return `
                <div class="animate-fade-in p-4 md:p-8"> <div class="mb-6"><h1 class="text-3xl font-bold text-white">Hist√≥rico de Transa√ß√µes</h1><p class="text-slate-400">Visualize todas as transa√ß√µes de PIX geradas e pagas.</p></div>
                    ${this.dateFilterComponent('transactions')}
                    <div class="card p-6 rounded-lg"><div id="transactions-table-container" class="overflow-x-auto"><table class="table-custom w-full text-sm"><thead><tr><th>Status</th><th>Valor</th><th>Origem</th><th>Provedor PIX</th><th>Data</th></tr></thead><tbody id="transactions-table-body"><tr><td colspan="5" class="text-center text-gray-500 py-8">Carregando transa√ß√µes...</td></tr></tbody></table></div></div>
                </div>`;
            },
            settings() {
                const { settings } = App.state.data;
                const providers = [
                    { value: 'pushinpay', text: 'PushinPay' },
                    { value: 'cnpay', text: 'CN Pay' },
                    { value: 'oasyfy', text: 'Oasy.fy' },
                    { value: 'syncpay', text: 'SyncPay' },
                    { value: 'brpix', text: 'BR PIX' }
                ];
                const createSelect = (name, selectedValue) => {
                    const options = providers.map(p => `<option value="${p.value}" ${p.value === selectedValue ? 'selected' : ''}>${p.text}</option>`).join('');
                    return `<select name="${name}" class="form-select w-full p-2">${options}<option value="" ${!selectedValue ? 'selected' : ''}>Nenhum</option></select>`;
                };
                return `
                <div class="animate-fade-in p-4 md:p-8"> <div class="mb-6"><h1 class="text-3xl font-bold text-white">Configura√ß√µes de PIX</h1><p class="text-slate-400">Configure seus provedores de pagamento e a ordem de prioridade.</p></div>
                    <form id="pixSettingsForm" class="max-w-4xl">
                        <div class="flex border-b border-slate-700 mb-6" id="pix-settings-tabs">
                            <button type="button" data-tab="priority" class="tab-button active">Ordem de Prioridade</button>
                            <button type="button" data-tab="credentials" class="tab-button ml-2">Chaves da API</button>
                        </div>

                        <div id="tab-priority" class="tab-content active space-y-8">
                            <div class="card p-6 rounded-lg">
                                <h2 class="text-xl font-semibold mb-2 text-white">Ordem de Prioridade dos Provedores</h2>
                                <p class="text-sm text-gray-400 mb-4">Defina a ordem em que o sistema tentar√° gerar o PIX. Se o Provedor Prim√°rio falhar, o sistema automaticamente tentar√° o pr√≥ximo na lista.</p>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div><label class="block mb-2 text-sm font-medium text-gray-400">1¬∫ - Provedor Prim√°rio</label>${createSelect('pix_provider_primary', settings.pix_provider_primary)}</div>
                                    <div><label class="block mb-2 text-sm font-medium text-gray-400">2¬∫ - Provedor Secund√°rio</label>${createSelect('pix_provider_secondary', settings.pix_provider_secondary)}</div>
                                    <div><label class="block mb-2 text-sm font-medium text-gray-400">3¬∫ - Provedor Terci√°rio</label>${createSelect('pix_provider_tertiary', settings.pix_provider_tertiary)}</div>
                                </div>
                                <div class="mt-6 pt-6 border-t border-slate-700"><button type="button" id="testPriorityRouteBtn" class="btn btn-green w-full md:w-auto">Testar Rota de Prioridade</button></div>
                            </div>
                        </div>

                        <div id="tab-credentials" class="tab-content space-y-6">
                            <div class="card p-6 rounded-lg">
                                <div class="flex justify-between items-start mb-4">
                                    <div><h3 class="text-lg font-medium text-sky-400 inline-block">BR PIX</h3><span id="status-indicator-brpix"></span></div>
                                    <button type="button" data-provider="brpix" class="test-pix-btn btn btn-secondary text-xs py-1 px-3">Testar Conex√£o</button>
                                </div>
                                <label class="block mb-2 text-sm text-gray-400">Secret Key</label><input name="brpix_secret_key" type="password" value="${settings.brpix_secret_key || ''}" class="form-input w-full p-2">
                                <label class="block mt-4 mb-2 text-sm text-gray-400">Company ID</label><input name="brpix_company_id" type="password" value="${settings.brpix_company_id || ''}" class="form-input w-full p-2">
                            </div>
                            <div class="card p-6 rounded-lg">
                                <div class="flex justify-between items-start mb-4">
                                    <div><h3 class="text-lg font-medium text-sky-400 inline-block">SyncPay</h3><span id="status-indicator-syncpay"></span></div>
                                    <button type="button" data-provider="syncpay" class="test-pix-btn btn btn-secondary text-xs py-1 px-3">Testar Conex√£o</button>
                                </div>
                                <label class="block mb-2 text-sm text-gray-400">Client ID</label><input name="syncpay_client_id" type="password" value="${settings.syncpay_client_id || ''}" class="form-input w-full p-2">
                                <label class="block mt-4 mb-2 text-sm text-gray-400">Client Secret</label><input name="syncpay_client_secret" type="password" value="${settings.syncpay_client_secret || ''}" class="form-input w-full p-2">
                            </div>
                            <div class="card p-6 rounded-lg">
                                <div class="flex justify-between items-start mb-4">
                                    <div><h3 class="text-lg font-medium text-sky-400 inline-block">PushinPay</h3><span id="status-indicator-pushinpay"></span></div>
                                    <button type="button" data-provider="pushinpay" class="test-pix-btn btn btn-secondary text-xs py-1 px-3">Testar Conex√£o</button>
                                </div>
                                <label class="block mb-2 text-sm text-gray-400">Bearer Token</label><input name="pushinpay_token" type="password" value="${settings.pushinpay_token || ''}" class="form-input w-full p-2">
                            </div>
                             <div class="card p-6 rounded-lg">
                                <div class="flex justify-between items-start mb-4">
                                    <div><h3 class="text-lg font-medium text-sky-400 inline-block">CN Pay</h3><span id="status-indicator-cnpay"></span></div>
                                    <button type="button" data-provider="cnpay" class="test-pix-btn btn btn-secondary text-xs py-1 px-3">Testar Conex√£o</button>
                                </div>
                                <label class="block mb-2 text-sm text-gray-400">Chave P√∫blica</label><input name="cnpay_public_key" type="password" value="${settings.cnpay_public_key || ''}" class="form-input w-full p-2">
                                <label class="block mt-4 mb-2 text-sm text-gray-400">Chave Privada</label><input name="cnpay_secret_key" type="password" value="${settings.cnpay_secret_key || ''}" class="form-input w-full p-2">
                            </div>
                            <div class="card p-6 rounded-lg">
                                 <div class="flex justify-between items-start mb-4">
                                    <div><h3 class="text-lg font-medium text-sky-400 inline-block">Oasy.fy</h3><span id="status-indicator-oasyfy"></span></div>
                                    <button type="button" data-provider="oasyfy" class="test-pix-btn btn btn-secondary text-xs py-1 px-3">Testar Conex√£o</button>
                                </div>
                                <label class="block mb-2 text-sm text-gray-400">Chave P√∫blica</label><input name="oasyfy_public_key" type="password" value="${settings.oasyfy_public_key || ''}" class="form-input w-full p-2">
                                <label class="block mt-4 mb-2 text-sm text-gray-400">Chave Privada</label><input name="oasyfy_secret_key" type="password" value="${settings.oasyfy_secret_key || ''}" class="form-input w-full p-2">
                            </div>
                        </div>
                        <div class="mt-8"><button type="submit" class="btn w-full p-3 font-bold rounded-md">Salvar Configura√ß√µes de PIX</button></div>
                    </form>
                </div>`;
            },
            integrations() {
                const { utmifyIntegrations } = App.state.data;
                const utmifyListHTML = utmifyIntegrations.map(u => `
                    <div class="p-3 bg-slate-900/50 rounded-lg flex justify-between items-center">
                        <span class="font-medium text-sm">${u.account_name}</span>
                        <button data-id="${u.id}" class="delete-utmify-btn btn btn-red text-xs py-1 px-2">Excluir</button>
                    </div>
                `).join('');

                return `
                <div class="animate-fade-in p-4 md:p-8"> <div class="mb-6"><h1 class="text-3xl font-bold text-white">Integra√ß√µes</h1><p class="text-slate-400">Conecte o HotTrack a outras ferramentas.</p></div>
                    <div class="max-w-2xl">
                        <div class="card p-6 rounded-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold text-white">Contas Utmify</h2>
                                <button id="add-utmify-btn" class="btn btn-secondary text-sm py-1 px-3">Adicionar Conta</button>
                            </div>
                            <p class="text-sm text-gray-400 mt-1 mb-4">Adicione suas contas da Utmify. Depois, na cria√ß√£o de uma Pressel, voc√™ poder√° escolher para qual conta os eventos de venda devem ser enviados.</p>
                            <div id="utmify-list" class="space-y-3">
                                ${utmifyListHTML.length ? utmifyListHTML : '<p class="text-gray-500 text-sm">Nenhuma conta Utmify cadastrada.</p>'}
                            </div>
                        </div>
                    </div>
                </div>`;
            },
            documentation() {
                return `
                <div class="animate-fade-in p-4 md:p-8"> <div class="mb-6"><h1 class="text-3xl font-bold text-white">API & Documenta√ß√£o</h1><p class="text-slate-400">Sua chave de API para integra√ß√µes e o guia de implementa√ß√£o.</p></div>
                    <div class="grid grid-cols-1 gap-8 max-w-4xl">
                        <div class="card p-6 rounded-lg">
                            <h2 class="text-xl font-semibold mb-2 text-white">Sua Chave de API HotTrack</h2>
                            <p class="text-sm text-gray-400 mb-4">Use esta chave para autenticar suas requisi√ß√µes na API HotTrack (ex: gerar PIX, consultar status).</p>
                            <div class="flex items-center gap-2">
                                <input id="hottrack-api-key" type="password" readonly value="${App.state.data.settings.api_key || ''}" class="form-input flex-grow p-2">
                                <button type="button" class="toggle-visibility-btn p-2 text-gray-400 hover:text-white" data-target="#hottrack-api-key">
                                    <svg class="pointer-events-none h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                                </button>
                                <button type="button" class="copy-btn btn text-sm py-2 px-3" data-target="#hottrack-api-key">Copiar</button>
                                <a href="https://documentacaohot.netlify.app/" target="_blank" rel="noopener noreferrer" class="btn btn-secondary text-sm py-2 px-3 flex items-center gap-2 whitespace-nowrap">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                    </svg>
                                    <span>Doc API</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>`;
            },
            modal(title, content) {
                return `<div id="modal" class="modal active"><div class="card p-6 rounded-lg w-full max-w-md animate-fade-in"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-white">${title}</h2><button id="closeModalBtn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>${content}</div></div>`;
            }
        },

        addAuthEventListeners() {
            const container = document.getElementById('app');
            container.addEventListener('click', async (e) => {
                if (e.target.id === 'showRegister') { e.preventDefault(); this.renderLogin('register'); }
                if (e.target.id === 'showLogin') { e.preventDefault(); this.renderLogin('login'); }
            });
            container.addEventListener('submit', async (e) => {
                const form = e.target;
                if (form.id === 'loginForm' || form.id === 'registerForm') {
                    e.preventDefault();
                    const data = Object.fromEntries(new FormData(form).entries());
                    const button = form.querySelector('button[type="submit"]');
                    const originalButtonText = button.innerHTML;
                    button.innerHTML = 'Processando...';
                    button.disabled = true;

                    if (form.id === 'loginForm') {
                        await this.login(data.email, data.password);
                    } else if (form.id === 'registerForm') {
                        const { name, email, password } = data;
                        await this.register(name, email, password);
                    }

                    button.innerHTML = originalButtonText;
                    button.disabled = false;
                }
            });
        },

        // *** FUN√á√ÉO addDashboardEventListeners ATUALIZADA ***
        addDashboardEventListeners() {
            const appEl = document.getElementById('app');
            if (!appEl) return;

            // Remove listener antigo para evitar duplica√ß√£o
            if (appEl._clickListener) {
                appEl.removeEventListener('click', appEl._clickListener);
            }
            if (appEl._submitListener) {
                appEl.removeEventListener('submit', appEl._submitListener);
            }

            appEl._clickListener = async (e) => { // Guarda a refer√™ncia
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');

                // Toggle Sidebar
                if (sidebar && overlay) {
                    const isOpenBtn = e.target.closest('#open-sidebar-btn');
                    const isCloseBtn = e.target.closest('#close-sidebar-btn');
                    const isOverlay = e.target.id === 'sidebar-overlay';
                    const isNavLink = e.target.closest('.nav-link');

                    if (isOpenBtn) {
                        sidebar.classList.remove('-translate-x-full');
                        overlay.classList.remove('hidden');
                    } else if (isCloseBtn || isOverlay || (isNavLink && window.innerWidth < 768 && !isNavLink.closest('a[target="_blank"]'))) {
                        sidebar.classList.add('-translate-x-full');
                        overlay.classList.add('hidden');
                    }
                }

                // Logout
                if (e.target.id === 'logoutButton') this.logout();

                // Close Modal (Agora fecha qualquer modal com esse bot√£o)
                if (e.target.closest('#closeModalBtn')) {
                     document.getElementById('modal-container').innerHTML = '';
                     // Adicional: Se estivermos na tela de resultado do criador de TY, volta para o criador
                     const resultScreenTY = document.getElementById('thankYouCreator')?.querySelector('#result-screen:not(.hidden)');
                     if(resultScreenTY) {
                         const form = document.getElementById('thank-you-form');
                         resultScreenTY.classList.add('hidden');
                         if(form) form.classList.remove('hidden');
                     }
                      // Adicional: Se estivermos na tela de resultado do criador de Checkout, volta para lista
                     const resultScreenCheckout = document.getElementById('pageCreator')?.querySelector('#result-screen:not(.hidden)');
                     if(resultScreenCheckout) {
                        this.navigateTo('checkouts'); // Ou poderia voltar para o criador se preferir
                     }
                }

                // Open Add Utmify Modal
                if (e.target.id === 'add-utmify-btn') {
                    this.showAddUtmifyModal();
                }

                // Navigate SPA
                const sidebarLink = e.target.closest('.nav-link[data-target]');
                if (sidebarLink && sidebarLink.dataset.target) {
                    if (sidebarLink.dataset.target === 'pageCreator') { this.state.editingCheckoutId = null; }
                    if (sidebarLink.dataset.target === 'thankYouCreator') { this.state.editingThankYouPageId = null; } // Limpa estado TY
                    this.navigateTo(sidebarLink.dataset.target);
                }

                // Bot√µes Criador de Checkout
                if (e.target.id === 'go-to-creator-btn') { this.state.editingCheckoutId = null; this.navigateTo('pageCreator'); }
                if (e.target.id === 'back-to-checkouts-btn') { this.state.editingCheckoutId = null; this.navigateTo('checkouts'); }
                const editCheckoutBtn = e.target.closest('.edit-checkout-btn');
                if (editCheckoutBtn) { this.state.editingCheckoutId = editCheckoutBtn.dataset.id; this.navigateTo('pageCreator'); }
                const copyCheckoutLinkBtn = e.target.closest('.copy-checkout-link-btn');
                if (copyCheckoutLinkBtn) { /* ... l√≥gica de copiar ... */
                    const link = `${window.location.origin}/oferta/${copyCheckoutLinkBtn.dataset.id}`;
                    try { await navigator.clipboard.writeText(link); const o=copyCheckoutLinkBtn.textContent; copyCheckoutLinkBtn.textContent='Copiado!'; setTimeout(()=>{copyCheckoutLinkBtn.textContent=o},2000); } catch(err){this.showToast('Erro.', 'error');}
                }

                // Bot√µes Criador/Listagem P√°gina de Obrigado
                if (e.target.id === 'go-to-thankyou-creator-btn') { this.state.editingThankYouPageId = null; this.navigateTo('thankYouCreator'); }
                // Adicionado bot√£o para voltar para a lista a partir do criador TY
                if (e.target.id === 'back-to-ty-list-btn') { this.state.editingThankYouPageId = null; this.navigateTo('thankYouPages'); }
                const editThankYouBtn = e.target.closest('.edit-thankyou-btn');
                if (editThankYouBtn) { this.state.editingThankYouPageId = editThankYouBtn.dataset.id; this.navigateTo('thankYouCreator'); }
                const copyThankYouLinkBtn = e.target.closest('.copy-thankyou-link-btn');
                if (copyThankYouLinkBtn) { /* ... l√≥gica de copiar ... */
                     const link = `${window.location.origin}/obrigado/${copyThankYouLinkBtn.dataset.id}`;
                     try { await navigator.clipboard.writeText(link); const o=copyThankYouLinkBtn.textContent; copyThankYouLinkBtn.textContent='Copiado!'; setTimeout(()=>{copyThankYouLinkBtn.textContent='Copiar Link'},2000); } catch(err){this.showToast('Erro.', 'error');}
                }
                 // Bot√£o "Ver minhas p√°ginas" no modal de sucesso TY
                if (e.target.id === 'view-ty-pages-btn') {
                    document.getElementById('modal-container').innerHTML = ''; // Fecha modal
                    this.navigateTo('thankYouPages'); // Navega para a lista
                }


                // Copy Buttons Gen√©rico
                const copyBtn = e.target.closest('.copy-btn');
                if (copyBtn) { /* ... l√≥gica de copiar ... */
                     const targetSelector = copyBtn.dataset.target; const targetInput = document.querySelector(targetSelector); if(targetInput){ const textToCopy=targetInput.value||targetInput.textContent; try { await navigator.clipboard.writeText(textToCopy); const o=copyBtn.textContent; copyBtn.textContent='Copiado!'; setTimeout(()=>{copyBtn.textContent=o},2000); } catch(err){ console.error('Falha:',err); this.showToast('Erro.', 'error'); } }
                }

                // Toggle Password Visibility
                const toggleBtn = e.target.closest('.toggle-visibility-btn');
                if (toggleBtn) { /* ... l√≥gica de toggle ... */
                    const targetSelector = toggleBtn.dataset.target; const targetInput = document.querySelector(targetSelector); if(targetInput){ const isPassword=targetInput.type==='password'; targetInput.type=isPassword?'text':'password'; toggleBtn.innerHTML=isPassword ? `<svg class="pointer-events-none h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781z" clip-rule="evenodd" /><path d="M12.454 16.697L9.75 13.992a2.5 2.5 0 01-3.482-3.482l-2.455-2.455a10.048 10.048 0 00-3.263 5.218C1.732 14.057 5.522 17 10 17a9.95 9.95 0 005.023-1.303l-2.57-2.57z" /></svg>` : `<svg class="pointer-events-none h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>`; }
                }

                // Generate Pressel Code
                if (e.target.classList.contains('generate-pressel-code-btn')) { /* ... */ const id=e.target.dataset.id; const p=this.state.data.pressels.find(x=>x.id==id); if(p)this.generatePresselCode(p); }

                // Test PIX Buttons
                if (e.target.classList.contains('test-pix-btn')) { /* ... */ this.testIndividualPixConnection(e.target.dataset.provider, e.target); }
                if (e.target.id === 'testPriorityRouteBtn') { /* ... */ this.testPriorityRoute(e.target); }

                // Tab Buttons
                const tabButton = e.target.closest('.tab-button');
                if (tabButton && tabButton.dataset.tab) { /* ... */ const tN=tabButton.dataset.tab; const c=tabButton.closest('form, div'); if(c){ c.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active')); tabButton.classList.add('active'); c.querySelectorAll('.tab-content').forEach(ct=>ct.classList.remove('active')); const aC=c.querySelector(`#tab-${tN}`); if(aC)aC.classList.add('active'); } }

                // Delete Buttons (Atualizado)
                const deleteBtn = e.target.closest('.delete-pixel-btn, .delete-bot-btn, .delete-pressel-btn, .delete-utmify-btn, .delete-checkout-btn, .delete-thankyou-btn');
                if (deleteBtn) {
                     const id = deleteBtn.dataset.id;
                    let type = '', endpoint = '', itemName = 'item', refreshFunction = () => this.navigateTo(this.state.currentPage);

                    if (deleteBtn.classList.contains('delete-pixel-btn')) { type = 'pixels'; endpoint = 'pixels'; itemName = 'pixel'; }
                    if (deleteBtn.classList.contains('delete-bot-btn')) { type = 'bots'; endpoint = 'bots'; itemName = 'bot'; }
                    if (deleteBtn.classList.contains('delete-pressel-btn')) { type = 'pressels'; endpoint = 'pressels'; itemName = 'pressel'; }
                    if (deleteBtn.classList.contains('delete-utmify-btn')) { type = 'utmifyIntegrations'; endpoint = 'integrations/utmify'; itemName = 'integra√ß√£o Utmify'; }
                    if (deleteBtn.classList.contains('delete-checkout-btn')) { type = 'checkouts'; endpoint = 'checkouts'; itemName = 'checkout'; refreshFunction = this.fetchAndRenderCheckouts; }
                    if (deleteBtn.classList.contains('delete-thankyou-btn')) { /* type = 'thankYouPages' (n√£o precisa mexer no state aqui); */ endpoint = 'thank-you-pages'; itemName = 'p√°gina de obrigado'; refreshFunction = this.fetchAndRenderThankYouPages; }

                    if (confirm(`Tem certeza que deseja excluir est${itemName.includes('integra√ß√£o') || itemName.includes('p√°gina') ? 'a' : 'e'} ${itemName}?`)) {
                        try {
                            await this.apiRequest(`/api/${endpoint}/${id}`, 'DELETE');
                            // Remove do estado se necess√°rio (opcional para listagens que sempre recarregam)
                            // if(type && Array.isArray(this.state.data[type])) {
                            //    this.state.data[type] = this.state.data[type].filter(item => item.id != id);
                            // }
                            await refreshFunction.call(this); // Chama a fun√ß√£o de refresh correta
                            this.showToast(`${itemName.charAt(0).toUpperCase() + itemName.slice(1)} exclu√≠d${itemName.includes('integra√ß√£o') || itemName.includes('p√°gina') ? 'a' : 'o'} com sucesso!`, 'success');
                        } catch(err) {
                             this.showToast(`Erro ao excluir ${itemName === 'integra√ß√£o Utmify' || itemName === 'p√°gina de obrigado' ? 'a' : 'o'} ${itemName}.`, 'error');
                        }
                    }
                }

                // Date Filters
                const filterContainer = e.target.closest('#transactions-date-filter, #dashboard-date-filter');
                if (filterContainer) { /* ... */ const p=filterContainer.id.split('-')[0]; const b=e.target.closest('button'); if(b?.dataset.period){this.handleFilterChange(p,b.dataset.period);}else if(b?.id===`apply-custom-date-filter-${p}`){const sD=document.getElementById(`${p}-start-date`).value; const eD=document.getElementById(`${p}-end-date`).value; if(sD&&eD){this.handleFilterChange(p,'custom',sD,eD);}else{this.showToast('Selecione datas.','error');}}else if(b?.id===`clear-date-filter-${p}`){this.handleFilterChange(p,'all');} }
            };
            appEl.addEventListener('click', appEl._clickListener); // Adiciona o novo listener

            // Listener de Submit (sem altera√ß√µes significativas aqui, submits espec√≠ficos s√£o tratados nas fun√ß√µes init)
            appEl._submitListener = async (e) => {
                const form = e.target.closest('form');
                if (!form || ['loginForm', 'registerForm', 'checkout-form', 'thank-you-form'].includes(form.id)) return; // Ignora forms espec√≠ficos

                e.preventDefault();
                const button = form.querySelector('button[type="submit"]');
                const originalButtonText = button ? button.innerHTML : 'Salvar';
                 if(button){ button.innerHTML = 'Salvando...'; button.disabled = true; }

                let data = Object.fromEntries(new FormData(form).entries());
                try {
                    if (form.id === 'pixSettingsForm') {
                        await this.apiRequest('/api/settings/pix', 'POST', data);
                        App.state.data.settings = { ...App.state.data.settings, ...data };
                        this.showToast('Configura√ß√µes PIX salvas!', 'success');
                         this.updateAllPixStatusIndicators();
                    }
                    else if (form.id === 'utmifySettingsForm') {
                        const newIntegration = await this.apiRequest('/api/integrations/utmify', 'POST', data);
                        if(newIntegration) {
                            this.state.data.utmifyIntegrations.unshift(newIntegration);
                             document.getElementById('modal-container').innerHTML = '';
                            this.navigateTo('integrations');
                            this.showToast('Conta Utmify adicionada!', 'success');
                        }
                    }
                    else if (form.id === 'pixelForm') {
                        const newPixel = await this.apiRequest('/api/pixels', 'POST', data);
                        if (newPixel) { this.state.data.pixels.unshift(newPixel); this.navigateTo('pixels'); this.showToast('Pixel adicionado!', 'success'); form.reset(); }
                    }
                    else if (form.id === 'botForm') {
                        const newBot = await this.apiRequest('/api/bots', 'POST', data);
                        if (newBot) { this.state.data.bots.unshift(newBot); this.navigateTo('bots'); this.showToast('Bot adicionado!', 'success'); form.reset(); }
                    }
                    else if (form.id === 'presselForm') {
                        const pixel_ids = Array.from(form.querySelectorAll('input[name="pixel_ids"]:checked')).map(cb => cb.value);
                        if (pixel_ids.length === 0) { this.showToast('Selecione ao menos um pixel.', 'error'); }
                        else {
                            const payload = { ...data, pixel_ids: pixel_ids.map(Number), utmify_integration_id: data.utmify_integration_id || null }; // Garante que √© null se vazio
                            const newPressel = await this.apiRequest('/api/pressels', 'POST', payload);
                            if (newPressel) {
                                const bot = this.state.data.bots.find(b => b.id == newPressel.bot_id);
                                const pWBn = {...newPressel, bot_name: bot ? bot.bot_name : '?'};
                                this.state.data.pressels.unshift(pWBn);
                                this.navigateTo('pressels');
                                this.generatePresselCode(pWBn);
                                form.reset();
                            }
                        }
                    }
                } catch(err) { /* Erros j√° tratados em apiRequest */ }
                finally {
                    if(button) { button.innerHTML = originalButtonText; button.disabled = false; }
                }
            };
            appEl.addEventListener('submit', appEl._submitListener); // Adiciona o novo listener
        },

        async apiRequest(endpoint, method = 'GET', body = null) {
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (this.state.token) { headers['Authorization'] = `Bearer ${this.state.token}`; }

                const apiKeyRequired = endpoint.includes('/api/checkouts/create-hosted') ||
                                       (endpoint.includes('/api/checkouts/') && method === 'PUT') ||
                                       endpoint.includes('/api/thank-you-pages/create') ||
                                       (endpoint.includes('/api/thank-you-pages/') && method === 'PUT'); // Adicionado PUT para TY pages

                if (this.state.data.settings && this.state.data.settings.api_key && apiKeyRequired) {
                    headers['x-api-key'] = this.state.data.settings.api_key;
                }

                const options = { method, headers };
                if (body) { options.body = JSON.stringify(body); }

                const response = await fetch(`${this.state.API_BASE_URL}${endpoint}`, options);

                if (response.status === 204) return null;

                const data = await response.json();

                if (!response.ok) {
                    console.error(`API Error ${response.status} on ${method} ${endpoint}:`, data);
                    let errorMsg = 'Erro desconhecido da API.';
                    if (data && data.message) {
                       errorMsg = data.message;
                    } else if (typeof data === 'string') {
                       errorMsg = data;
                    }
                    throw new Error(errorMsg);
                }
                return data;
            } catch (error) {
                 if (error instanceof Error) {
                    this.showToast(error.message, 'error');
                    // N√£o faz logout autom√°tico para API Key inv√°lida nos criadores, s√≥ no login/auth
                    if ((error.message.includes('inv√°lido') || error.message.includes('expirado')) && !endpoint.includes('/create') && !endpoint.includes('/checkouts/') && !endpoint.includes('/thank-you-pages/')) {
                       this.logout();
                    }
                 } else {
                    console.error(`Network Error on ${method} ${endpoint}:`, error);
                    this.showToast('Falha na conex√£o com o servidor.', 'error');
                 }
                 throw error;
            }
        },

        async login(email, password) {
            try {
                const data = await this.apiRequest('/api/sellers/login', 'POST', { email, password });
                this.state.token = data.token;
                localStorage.setItem('hottrack_token', data.token);
                window.location.reload();
            } catch (e) { /* Erro j√° mostrado */ }
        },

        async register(name, email, password) {
            try {
                await this.apiRequest('/api/sellers/register', 'POST', { name, email, password });
                this.showToast('Cadastro realizado! Redirecionando para aprova√ß√£o...', 'success');
                const message = `Ol√°, gostaria de solicitar a aprova√ß√£o do meu cadastro. Email: ${email}`;
                const whatsappUrl = `https://wa.me/5541995211148?text=${encodeURIComponent(message)}`;
                setTimeout(() => { window.location.href = whatsappUrl; }, 1000);
            } catch (e) { /* Erro j√° mostrado */ }
        },

        logout() {
            this.state.token = null;
            this.state.editingCheckoutId = null;
            this.state.editingThankYouPageId = null; // Limpa estado TY no logout
            localStorage.removeItem('hottrack_token');
            window.location.reload();
        },

        showAddUtmifyModal() {
            const modalContent = `
                <form id="utmifySettingsForm" class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-400 mb-1">Nome da Conta</label><input name="account_name" type="text" placeholder="Ex: Produto X - Utmify" class="form-input w-full p-2" required></div>
                    <div><label class="block text-sm font-medium text-gray-400 mb-1">Token da API Utmify (x-api-token)</label><input name="api_token" type="password" class="form-input w-full p-2" required></div>
                    <div class="pt-2"><button type="submit" class="btn w-full p-2 font-bold rounded-md">Salvar Integra√ß√£o</button></div>
                </form>
            `;
            document.getElementById('modal-container').innerHTML = this.templates.modal('Adicionar Conta Utmify', modalContent);
        },
        async viewDispatchDetails(logId) { /* ... (sem altera√ß√µes) ... */ },

        // *** FUN√á√ÉO NAVIGATETO ATUALIZADA ***
        async navigateTo(page) {
            this.state.currentPage = page;
            const contentContainer = document.getElementById('content');
            if (!contentContainer || !this.templates[page]) {
                console.error(`Template para a p√°gina "${page}" n√£o encontrado.`);
                return;
            }

            contentContainer.innerHTML = `<div class="flex items-center justify-center h-full"><svg class="animate-spin h-6 w-6 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>`;

            // Controla o scroll do #content
            if (page === 'pageCreator' || page === 'thankYouCreator') { // Adicionado thankYouCreator
                contentContainer.classList.remove('overflow-y-auto', 'p-4', 'md:p-8');
                contentContainer.classList.add('overflow-hidden');
            } else {
                contentContainer.classList.add('overflow-y-auto', 'p-4', 'md:p-8');
                contentContainer.classList.remove('overflow-hidden');
            }

            await new Promise(resolve => setTimeout(resolve, 10));

            try {
                contentContainer.innerHTML = this.templates[page]();
                document.querySelectorAll('.nav-link[data-target]').forEach(item => item.classList.toggle('active', item.dataset.target === page));

                // Inicializa JS espec√≠fico da p√°gina
                if (page === 'dashboard') { this.handleFilterChange(page, this.state.dateFilter.period || 'last7days'); }
                else if (page === 'transactions') { this.handleFilterChange(page, this.state.dateFilter.period || 'all'); }
                else if (page === 'settings') { this.updateAllPixStatusIndicators(); }
                else if (page === 'bots') { this.updateAllBotStatusIndicators(); }
                else if (page === 'pageCreator') { await this.initCreatorPage(); }
                else if (page === 'thankYouCreator') { await this.initThankYouCreatorPage(); } // Tornou async
                else if (page === 'thankYouPages') { await this.fetchAndRenderThankYouPages(); } // Chamada para listar TY pages
                else if (page === 'checkouts') { await this.fetchAndRenderCheckouts(); }

            } catch (renderError) {
                 console.error(`Erro ao renderizar ou inicializar a p√°gina "${page}":`, renderError);
                 contentContainer.innerHTML = `<p class="text-center text-red-400">Erro ao carregar a se√ß√£o ${page}.</p>`;
            }
        },

        async fetchDashboardMetrics() { /* ... (sem altera√ß√µes) ... */ },
        async fetchAchievementsAndRanking() { /* ... (sem altera√ß√µes) ... */ },
        async fetchTransactions() { /* ... (sem altera√ß√µes) ... */ },
        renderTransactionsTable() { /* ... (sem altera√ß√µes) ... */ },
        handleFilterChange(page, period, customStartDate, customEndDate) { /* ... (sem altera√ß√µes) ... */ },
        renderRevenueChart() { /* ... (sem altera√ß√µes) ... */ },
        generatePresselCode(pressel) { /* ... (sem altera√ß√µes) ... */ },
        async testIndividualPixConnection(provider, button) { /* ... (sem altera√ß√µes) ... */ },
        async testPriorityRoute(button) { /* ... (sem altera√ß√µes) ... */ },
        updateAllBotStatusIndicators() { /* ... (sem altera√ß√µes) ... */ },
        updateBotStatusIndicator(botId) { /* ... (sem altera√ß√µes) ... */ },
        updateAllPixStatusIndicators() { /* ... (sem altera√ß√µes) ... */ },
        updatePixStatusIndicator(provider, mode) { /* ... (sem altera√ß√µes) ... */ },
        formatTimeAgo(timestamp) { /* ... (sem altera√ß√µes) ... */ },
        showToast(message, type = 'success') { /* ... (sem altera√ß√µes) ... */ },

        // *** FUN√á√ÉO fetchAndRenderCheckouts ATUALIZADA ***
        async fetchAndRenderCheckouts() {
            const tableBody = document.getElementById('checkouts-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-8">Carregando...</td></tr>';
            try {
                const checkouts = await this.apiRequest('/api/checkouts');
                this.state.data.checkouts = checkouts;
                if (checkouts.length > 0) {
                    tableBody.innerHTML = checkouts.map(c => `
                        <tr class="hover:bg-slate-800/50">
                            <td class="font-medium">${c.name || 'Checkout Sem T√≠tulo'}</td>
                            <td>${new Date(c.created_at).toLocaleString('pt-BR')}</td>
                            <td class="text-right space-x-2">
                                <button class="btn-secondary btn-sm py-1 px-2 copy-checkout-link-btn" data-id="${c.id}">Copiar Link</button>
                                <button class="btn-secondary btn-sm py-1 px-2 edit-checkout-btn" data-id="${c.id}">Editar</button>
                                <button class="btn-red btn-sm py-1 px-2 delete-checkout-btn" data-id="${c.id}">Excluir</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-8">Nenhum checkout criado ainda.</td></tr>';
                }
            } catch (e) {
                console.error("Erro ao buscar checkouts:", e);
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-red-400 py-8">Erro ao carregar checkouts.</td></tr>';
            }
        },

        // *** FUN√á√ÉO fetchAndRenderThankYouPages ADICIONADA ***
        async fetchAndRenderThankYouPages() {
            const tableBody = document.getElementById('thankyou-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-8">Carregando...</td></tr>';
            try {
                const pages = await this.apiRequest('/api/thank-you-pages');
                // this.state.data.thankYouPages = pages; // Opcional: salvar no estado
                if (pages.length > 0) {
                    tableBody.innerHTML = pages.map(p => `
                        <tr class="hover:bg-slate-800/50">
                            <td class="font-medium">${p.name || 'P√°gina Sem Nome'}</td>
                            <td>${new Date(p.created_at).toLocaleString('pt-BR')}</td>
                            <td class="text-right space-x-2">
                                <button class="btn-secondary btn-sm py-1 px-2 copy-thankyou-link-btn" data-id="${p.id}">Copiar Link</button>
                                <button class="btn-secondary btn-sm py-1 px-2 edit-thankyou-btn" data-id="${p.id}">Editar</button>
                                <button class="btn-red btn-sm py-1 px-2 delete-thankyou-btn" data-id="${p.id}">Excluir</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-8">Nenhuma p√°gina de obrigado criada ainda.</td></tr>';
                }
            } catch (e) {
                console.error("Erro ao buscar p√°ginas de obrigado:", e);
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-red-400 py-8">Erro ao carregar p√°ginas.</td></tr>';
            }
        },

        // *** FUN√á√ÉO initCreatorPage ATUALIZADA ***
        async initCreatorPage() {
            const FRONTEND_URL = window.location.origin;
            const contentEl = document.getElementById('content');
            if (!contentEl) { console.error("Container #content n√£o encontrado."); return; }

            const creatorTitle = contentEl.querySelector('#creator-title');
            const submitBtn = contentEl.querySelector('#submit-btn');
            const checkoutForm = contentEl.querySelector('#checkout-form');
            const packagesContainer = contentEl.querySelector('#packages-container');
            const testimonialsContainer = contentEl.querySelector('#testimonials-container');
            const pixelSelect = contentEl.querySelector('#pixel_id');
            const utmifySelect = contentEl.querySelector('#utmify_integration_id');
            const resultScreen = contentEl.querySelector('#result-screen');
            const checkoutLinkOutput = contentEl.querySelector('#checkout-link-output');

            // Limpa containers antes de popular (importante para edi√ß√£o)
            if (packagesContainer) packagesContainer.innerHTML = '';
            if (testimonialsContainer) testimonialsContainer.innerHTML = '';

            // Popula selects
            if (pixelSelect) {
                 pixelSelect.innerHTML = '<option value="">-- Selecione um Pixel --</option>' + App.state.data.pixels.map(p => `<option value="${p.pixel_id}">${p.account_name} (${p.pixel_id})</option>`).join('');
            }
            if (utmifySelect) {
                utmifySelect.innerHTML = '<option value="">-- Nenhuma --</option>' + App.state.data.utmifyIntegrations.map(u => `<option value="${u.id}">${u.account_name}</option>`).join('');
            }

            // Fun√ß√µes auxiliares (addPackage, addTestimonial, etc.)
            let packageCount = 0;
            function addPackage(title = 'Acesso Completo', desc = 'Todo o conte√∫do liberado.', val = '29.90') {
                 if (!packagesContainer) return;
                packageCount++; const el = document.createElement('div'); el.id = `package-${packageCount}`; el.className = 'grid grid-cols-1 md:grid-cols-7 gap-4 border border-slate-700 p-4 rounded-lg';
                el.innerHTML = `<div class="md:col-span-2"><label class="text-xs text-gray-400 mb-1 block">Nome</label><input type="text" class="form-input w-full p-2 package-title" value="${title}" required></div> <div class="md:col-span-3"><label class="text-xs text-gray-400 mb-1 block">Descri√ß√£o</label><input type="text" class="form-input w-full p-2 package-description" value="${desc}" required></div> <div class="md:col-span-1"><label class="text-xs text-gray-400 mb-1 block">Valor (R$)</label><input type="number" step="0.01" min="0" class="form-input w-full p-2 package-value" value="${val}" required></div> <div class="flex items-end"><button type="button" class="btn btn-danger w-full h-10 remove-package-btn" data-id="${packageCount}">X</button></div>`;
                packagesContainer.appendChild(el);
            }
            let testimonialCount = 0;
            function addTestimonial(name = '', photo_url = '', text = '') {
                 if (!testimonialsContainer) return;
                testimonialCount++; const el = document.createElement('div'); el.id = `testimonial-${testimonialCount}`; el.className = 'border border-slate-700 p-4 rounded-lg space-y-3';
                el.innerHTML = `<div class="flex justify-end"><button type="button" class="btn btn-danger text-xs py-1 px-2 remove-testimonial-btn" data-id="${testimonialCount}">Remover</button></div> <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <div><label class="text-xs text-gray-400 mb-1 block">Nome</label><input type="text" class="form-input w-full p-2 testimonial-name" value="${name}" placeholder="Ex: Jo√£o da Silva"></div> <div><label class="text-xs text-gray-400 mb-1 block">URL da Foto (Opcional)</label><input type="url" class="form-input w-full p-2 testimonial-photo" value="${photo_url}" placeholder="https://..."></div> </div> <div><label class="text-xs text-gray-400 mb-1 block">Texto</label><textarea class="form-textarea w-full p-2 testimonial-text" rows="3" placeholder="Excelente produto...">${text}</textarea></div>`;
                testimonialsContainer.appendChild(el);
            }
            function populateCreatorForm(config) { /* ... (sem altera√ß√µes) ... */
                const get = (selector) => contentEl.querySelector(selector);
                get('#main_title').value = config.content.main_title || ''; get('#subtitle').value = config.content.subtitle || ''; get('#media_url').value = config.content.media_url || '';
                get('#pricing-type-select').value = config.pricing.type || 'fixed'; packagesContainer.innerHTML=''; if (config.pricing.type === 'fixed' && config.pricing.packages?.length > 0) { config.pricing.packages.forEach(pkg => addPackage(pkg.title, pkg.description, (pkg.value_cents / 100).toFixed(2))); } else { addPackage(); }
                get('#enable_order_bump').checked = config.order_bump.enabled; get('#order-bump-fields').classList.toggle('hidden', !config.order_bump.enabled); get('#order_bump_product_name').value = config.order_bump.product_name || ''; get('#order_bump_description').value = config.order_bump.description || ''; get('#order_bump_value').value = (config.order_bump.value_cents / 100).toFixed(2) || '0.00';
                get('#enable_countdown').checked = config.conversion_elements.countdown.enabled; get('#countdown-fields').classList.toggle('hidden', !config.conversion_elements.countdown.enabled); get('#countdown_minutes').value = config.conversion_elements.countdown.minutes || 15;
                get('#guarantee_text').value = config.conversion_elements.guarantee.text || ''; get('#guarantee_seal_url').value = config.conversion_elements.guarantee.seal_url || '';
                testimonialsContainer.innerHTML=''; if (config.testimonials?.length > 0) { config.testimonials.forEach(t => addTestimonial(t.name, t.photo_url, t.text)); }
                get('#pixel_id').value = config.tracking.pixel_id || ''; get('#utmify_integration_id').value = config.tracking.utmify_integration_id || ''; get('#background_color').value = config.style.background_color || '#0f172a'; get('#accent_color').value = config.style.accent_color || '#38bdf8';
            }
            function getFormData() { /* ... (sem altera√ß√µes) ... */
                 const getElValue=(s,d='')=>contentEl.querySelector(s)?.value||d; const getElChecked=(s)=>contentEl.querySelector(s)?.checked||false; const getElFloat=(s,d=0)=>parseFloat(contentEl.querySelector(s)?.value)||d; const getElInt=(s,d=0)=>parseInt(contentEl.querySelector(s)?.value)||d; const pT=getElValue('#pricing-type-select','fixed'); let pD; if(pT==='fixed'){pD={type:'fixed',packages:Array.from(contentEl.querySelectorAll('#packages-container > div')).map(p=>({title:p.querySelector('.package-title')?.value||'',description:p.querySelector('.package-description')?.value||'',value_cents:Math.round((parseFloat(p.querySelector('.package-value')?.value)||0)*100)}))};}else{pD={type:'open',label:getElValue('#open_value_label'),minimum_value_cents:Math.round(getElFloat('#open_value_min',5)*100),suggested_value_cents:Math.round(getElFloat('#open_value_suggested',50)*100)};}
                 return{content:{main_title:getElValue('#main_title'),subtitle:getElValue('#subtitle'),media_url:getElValue('#media_url')||null},pricing:pD,order_bump:{enabled:getElChecked('#enable_order_bump'),product_name:getElValue('#order_bump_product_name'),description:getElValue('#order_bump_description'),value_cents:Math.round(getElFloat('#order_bump_value',0)*100)},conversion_elements:{countdown:{enabled:getElChecked('#enable_countdown'),minutes:getElInt('#countdown_minutes',15)},guarantee:{text:getElValue('#guarantee_text',''),seal_url:getElValue('#guarantee_seal_url')||null}},testimonials:Array.from(contentEl.querySelectorAll('#testimonials-container > div')).map(t=>({name:t.querySelector('.testimonial-name')?.value||'',text:t.querySelector('.testimonial-text')?.value||'',photo_url:t.querySelector('.testimonial-photo')?.value||null})),style:{background_color:getElValue('#background_color','#0f172a'),accent_color:getElValue('#accent_color','#38bdf8')},tracking:{pixel_id:getElValue('#pixel_id',''),utmify_integration_id:getElValue('#utmify_integration_id','')||null}};
            }
            function generatePreviewHTML(data) { /* ... (sem altera√ß√µes) ... */
                 const fC=(c)=>(c/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); const cdH=data.conversion_elements.countdown.enabled?`<div style="background-color: var(--preview-accent, #38bdf8); color: white; text-align: center; padding: 0.75rem;"><p style="font-weight: 600; font-size: 0.9rem;">A OFERTA TERMINA EM</p><p style="font-size: 1.5rem; font-weight: 800; letter-spacing: 0.1em;">${String(data.conversion_elements.countdown.minutes).padStart(2,'0')}:00</p></div>`:''; const mH=data.content.media_url?`<img src="${data.content.media_url}" alt="Preview" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 0.5rem; margin-bottom: 1.5rem;">`:''; let pH; if(data.pricing.type==='open'){pH=`<div style="margin-top: 1.5rem;"><label ...>${data.pricing.label||'Escolha o valor'}</label><div ...><span ...>R$</span><input ... placeholder="${(data.pricing.suggested_value_cents/100).toFixed(2).replace('.',',')}" ...></div><p ...>M√≠nimo: ${fC(data.pricing.minimum_value_cents)}</p></div>`;}else{const p=Array.isArray(data.pricing.packages)?data.pricing.packages:[];pH=(p.length>0?p:[{title:'Configure',description:'',value_cents:0}]).map((pk,i)=>`<div style="border: 1px solid #e5e7eb; padding: 1rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s;" onclick="this.style.borderColor=getComputedStyle(document.documentElement).getPropertyValue('--preview-accent'); this.style.boxShadow = '0 0 0 2px '+getComputedStyle(document.documentElement).getPropertyValue('--preview-accent');"><h3 style="font-weight: 700; font-size: 1.1rem; color: #111827;">${pk.title||'Pacote'}</h3><p style="font-size: 0.9rem; color: #6b7280; margin-top: 0.25rem;">${pk.description||'Descri√ß√£o'}</p><p style="font-size: 1.5rem; font-weight: 800; color: var(--preview-accent, #38bdf8); margin-top: 0.75rem;">${fC(pk.value_cents)}</p></div>`).join(''); pH=`<div style="margin-top: 1.5rem; display: flex; flex-direction: column; gap: 1rem;">${pH}</div>`;}
                 const obH=data.order_bump.enabled&&data.order_bump.product_name?`<div style="background-color: #fefce8; border: 2px dashed #facc15; padding: 1rem; border-radius: 0.5rem; margin-top: 1.5rem;"><div style="display: flex; align-items: flex-start; gap: 0.75rem;"><input type="checkbox" style="width: 1.5rem; height: 1.5rem; margin-top: 0.25rem; accent-color: #ca8a04;"><div><h4 style="font-weight: 700; color: #ca8a04;">${data.order_bump.product_name}</h4><p style="font-size: 0.9rem; color: #4b5563;">${data.order_bump.description}</p></div></div></div>`:''; const gH=data.conversion_elements.guarantee.text?`<div style="margin-top: 2rem; display: flex; align-items: center; gap: 1rem; background-color: #f9fafb; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb;">${data.conversion_elements.guarantee.seal_url?`<img src="${data.conversion_elements.guarantee.seal_url}" alt="Selo" style="width: 60px; height: 60px;">`:''}<div><h4 style="font-weight: 700; color: #374151;">Garantia</h4><p style="font-size: 0.9rem; color: #6b7280;">${data.conversion_elements.guarantee.text}</p></div></div>`:''; const t=Array.isArray(data.testimonials)?data.testimonials:[]; const tH=t.filter(x=>x.name&&x.text).length>0?`<div style="margin-top: 2.5rem;"><h3 style="font-size: 1.5rem; font-weight: 800; text-align: center; color: ${data.style.background_color==='#ffffff'?'#111827':'#f1f5f9'}; margin-bottom: 1.5rem;">Clientes Dizem</h3><div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">${t.map(x=>`<div style="background-color: #f9fafb; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; color: #1f2937;"><div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">${x.photo_url?`<img src="${x.photo_url}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">`:''}<p style="font-weight: 600; color: #111827;">${x.name}</p></div><p style="font-size: 0.9rem; color: #4b5563; font-style: italic;">"${x.text}"</p></div>`).join('')}</div></div>`:'';
                 return`<div id="preview-body" style="--preview-bg: ${data.style.background_color}; --preview-accent: ${data.style.accent_color}; background-color: var(--preview-bg); color: ${data.style.background_color==='#ffffff'?'#1f2937':'#f1f5f9'}; min-height: 100%; font-family: 'Inter', sans-serif;">${cdH}<div style="padding: 1.5rem 2rem;"><h1 style="font-size: 1.8rem; font-weight: 800; text-align: center; color: ${data.style.background_color==='#ffffff'?'#111827':'#f1f5f9'};">${data.content.main_title||'T√≠tulo'}</h1><p style="text-align: center; color: ${data.style.background_color==='#ffffff'?'#6b7280':'#94a3b8'}; margin-top: 0.5rem; margin-bottom: 2rem;">${data.content.subtitle||'Subt√≠tulo'}</p>${mH}${pH}${obH}<button disabled style="width: 100%; background-color: var(--preview-accent, #38bdf8); color: white; font-weight: 700; padding: 1rem; border-radius: 0.5rem; margin-top: 1.5rem; font-size: 1.1rem; text-transform: uppercase; border: none; cursor: not-allowed;">Comprar</button>${gH}${tH}</div></div>`;
            }
            function updatePreview() { if (App.state.currentPage === 'pageCreator' && contentEl.querySelector('#creator-screen') && contentEl.querySelector('#preview-content')) { try { const data = getFormData(); contentEl.querySelector('#preview-content').innerHTML = generatePreviewHTML(data); const pb = contentEl.querySelector('#preview-content').querySelector('#preview-body'); if(pb) { pb.style.setProperty('--preview-bg', data.style.background_color); pb.style.setProperty('--preview-accent', data.style.accent_color); } } catch (e) { console.error("Erro no updatePreview:", e); } } }
            function showResultScreen(checkoutId) { if (!checkoutLinkOutput || !resultScreen) return; const link = `${FRONTEND_URL}/oferta/${checkoutId}`; checkoutLinkOutput.value = link; resultScreen.classList.remove('hidden'); }
            function hideResultScreen() { if (!resultScreen || !checkoutForm || !packagesContainer || !testimonialsContainer) return; resultScreen.classList.add('hidden'); checkoutForm.reset(); contentEl.querySelector('#pricing-type-select').value = 'fixed'; contentEl.querySelector('#fixed-pricing-container').classList.remove('hidden'); contentEl.querySelector('#open-pricing-container').classList.add('hidden'); contentEl.querySelector('#enable_order_bump').checked = false; contentEl.querySelector('#order-bump-fields').classList.add('hidden'); contentEl.querySelector('#enable_countdown').checked = false; contentEl.querySelector('#countdown-fields').classList.add('hidden'); packagesContainer.innerHTML = ''; testimonialsContainer.innerHTML = ''; addPackage(); updatePreview(); }

            if (this.state.editingCheckoutId) {
                creatorTitle.textContent = 'Editar Checkout'; submitBtn.textContent = 'Carregando...'; submitBtn.disabled = true;
                try {
                    const data = await this.apiRequest(`/api/oferta/${this.state.editingCheckoutId}`);
                    if (data && data.config) { populateCreatorForm(data.config); submitBtn.textContent = 'Salvar Altera√ß√µes'; } else { throw new Error('Config n√£o encontrada.'); }
                } catch (e) { this.showToast('Erro ao carregar.', 'error'); this.state.editingCheckoutId = null; creatorTitle.textContent = 'Criador'; submitBtn.textContent = 'Criar'; addPackage(); }
                finally { submitBtn.disabled = false; updatePreview(); }
            } else {
                creatorTitle.textContent = 'Criador de Ofertas'; submitBtn.textContent = 'Criar Checkout'; addPackage(); updatePreview();
            }

            // Listeners
            contentEl.removeEventListener('input', updatePreview); // Garante que n√£o haja duplicatas
            contentEl.addEventListener('input', updatePreview);
            contentEl.removeEventListener('change', contentEl._changeListener);
            contentEl._changeListener = (e) => { /* ... l√≥gica do change listener ... */
                 if (e.target.matches('#pricing-type-select, #enable_order_bump, #enable_countdown')) { const pS=contentEl.querySelector('#pricing-type-select'); const fC=contentEl.querySelector('#fixed-pricing-container'); const oC=contentEl.querySelector('#open-pricing-container'); const eOB=contentEl.querySelector('#enable_order_bump'); const oBF=contentEl.querySelector('#order-bump-fields'); const eC=contentEl.querySelector('#enable_countdown'); const cF=contentEl.querySelector('#countdown-fields'); const iF=pS.value==='fixed'; if(fC)fC.classList.toggle('hidden',!iF); if(oC)oC.classList.toggle('hidden',iF); if(oBF)oBF.classList.toggle('hidden',!eOB.checked); if(cF)cF.classList.toggle('hidden',!eC.checked); updatePreview(); } if (e.target.matches('#pixel_id')) updatePreview();
            };
            contentEl.addEventListener('change', contentEl._changeListener);

            contentEl.removeEventListener('click', contentEl._clickListener);
            contentEl._clickListener = (e) => { /* ... l√≥gica do click listener ... */
                 if(e.target.id==='add-package-btn')addPackage(); if(e.target.id==='add-testimonial-btn')addTestimonial(); const rPB=e.target.closest('.remove-package-btn'); if(rPB){contentEl.querySelector(`#package-${rPB.dataset.id}`)?.remove();updatePreview();} const rTB=e.target.closest('.remove-testimonial-btn'); if(rTB){contentEl.querySelector(`#testimonial-${rTB.dataset.id}`)?.remove();updatePreview();}
                 const pW=contentEl.querySelector('#preview-wrapper'); if(e.target.id==='desktop-view-btn'){pW.className='desktop mx-auto'; e.target.classList.add('active'); contentEl.querySelector('#mobile-view-btn').classList.remove('active');} if(e.target.id==='mobile-view-btn'){pW.className='mobile mx-auto'; e.target.classList.add('active'); contentEl.querySelector('#desktop-view-btn').classList.remove('active');}
                 if(e.target.id==='copy-link-btn'){checkoutLinkOutput.select(); document.execCommand('copy'); e.target.textContent='Copiado!'; setTimeout(()=>{e.target.textContent='Copiar Link'},2000);} if(e.target.id==='create-another-btn'){hideResultScreen(); App.navigateTo('checkouts');}
            };
            contentEl.addEventListener('click', contentEl._clickListener);

             checkoutForm.removeEventListener('submit', checkoutForm._submitListener);
             checkoutForm._submitListener = async (e) => { /* ... l√≥gica do submit ... */
                 e.preventDefault(); const b=submitBtn; const oT=b.textContent; b.textContent='Salvando...'; b.disabled=true;
                 try{ const cD=getFormData(); if(cD.pricing.type==='fixed'&&(!cD.pricing.packages||cD.pricing.packages.length===0))throw new Error('Adicione um pacote.'); if(!cD.tracking.pixel_id)throw new Error('Pixel obrigat√≥rio.');
                 if(App.state.editingCheckoutId){await App.apiRequest(`/api/checkouts/${App.state.editingCheckoutId}`,'PUT',cD); App.showToast('Atualizado!', 'success'); App.state.editingCheckoutId=null; App.navigateTo('checkouts');}else{const r=await App.apiRequest('/api/checkouts/create-hosted','POST',cD); if(r&&r.checkoutId){showResultScreen(r.checkoutId);}else{throw new Error('Erro API.');}}}catch(error){App.showToast(error.message||'Erro.','error'); b.disabled=false; b.textContent=oT;}
             };
             checkoutForm.addEventListener('submit', checkoutForm._submitListener);
        },

        // *** FUN√á√ÉO initThankYouCreatorPage ATUALIZADA PARA EDI√á√ÉO ***
        initThankYouCreatorPage: async function() {
            const FRONTEND_URL = window.location.origin;
            const creatorScreen = document.getElementById('creator-screen');
            if (!creatorScreen) return;

            const thankYouForm = document.getElementById('thank-you-form');
            const submitBtn = document.getElementById('submit-btn');
            const resultScreen = document.getElementById('result-screen');
            const pageLinkOutput = document.getElementById('page-link-output');
            const copyLinkBtn = document.getElementById('copy-link-btn');
            const createAnotherBtn = document.getElementById('create-another-btn');
            const utmifySelect = document.getElementById('utmify_integration_id');
            const previewContent = document.getElementById('preview-content');
            const pageTitle = creatorScreen.querySelector('h1');
            const backBtn = document.getElementById('back-to-ty-list-btn'); // Bot√£o Voltar/Cancelar

            // Esconde bot√£o de voltar se n√£o estiver no contexto do painel (acesso direto?)
             if (!document.getElementById('sidebar')) { if(backBtn) backBtn.style.display = 'none'; }


            const apiKey = App.state.data.settings.api_key;
            if (!apiKey) {
                App.showToast("Chave de API n√£o encontrada. Salve-a na p√°gina 'API PIX'.", "error");
                submitBtn.disabled = true;
                return;
            } else {
                 submitBtn.disabled = false;
            }

            utmifySelect.innerHTML = '<option value="">N√£o enviar</option>';
            if (App.state.data.utmifyIntegrations) {
                App.state.data.utmifyIntegrations.forEach(int => {
                    const option = document.createElement('option'); option.value = int.id; option.textContent = int.account_name; utmifySelect.appendChild(option);
                });
            }

            function populateForm(config) {
                 document.getElementById('page_name').value = config.page_name || ''; document.getElementById('main_title').value = config.main_title || ''; document.getElementById('subtitle').value = config.subtitle || ''; document.getElementById('button_text').value = config.button_text || ''; document.getElementById('redirect_url').value = config.redirect_url || ''; document.getElementById('purchase_value').value = config.purchase_value || ''; document.getElementById('pixel_id').value = config.pixel_id || ''; document.getElementById('utmify_integration_id').value = config.utmify_integration_id || '';
            }

            if (App.state.editingThankYouPageId) {
                pageTitle.textContent = 'Editar P√°gina de Obrigado'; submitBtn.textContent = 'Carregando...'; submitBtn.disabled = true; if(backBtn) backBtn.textContent = 'Cancelar Edi√ß√£o';
                try {
                    const pageData = await App.apiRequest(`/api/thank-you-pages/${App.state.editingThankYouPageId}`); // Usa JWT para buscar
                    if (pageData && pageData.config) { populateForm(pageData.config); submitBtn.textContent = 'Salvar Altera√ß√µes'; } else { throw new Error('Configura√ß√£o n√£o encontrada.'); }
                } catch (e) { App.showToast('Erro ao carregar.', 'error'); App.state.editingThankYouPageId = null; pageTitle.textContent = 'Criador de P√°gina de Obrigado'; submitBtn.textContent = 'Gerar P√°gina'; if(backBtn) backBtn.textContent = 'Voltar para Lista'; thankYouForm.reset(); }
                finally { submitBtn.disabled = false; updatePreview(); }
            } else {
                pageTitle.textContent = 'Criador de P√°gina de Obrigado'; submitBtn.textContent = 'Gerar P√°gina'; if(backBtn) backBtn.textContent = 'Voltar para Lista'; thankYouForm.reset(); updatePreview();
            }

             function updatePreview() { /* ... (sem altera√ß√µes) ... */
                 if (!previewContent) return; const data = { main_title: document.getElementById('main_title').value, subtitle: document.getElementById('subtitle').value, button_text: document.getElementById('button_text').value, redirect_url: document.getElementById('redirect_url').value, };
                 previewContent.innerHTML = `<div style="background-color: var(--bg-secondary); color: var(--text-primary); font-family: 'Inter', sans-serif; min-height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; padding: 2rem;"> <div> <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-400 mx-auto mb-4" viewBox="0 0 20 20" fill="currentColor"> <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /> </svg> <h1 style="font-size: 2.25rem; font-weight: 800; color: white;">${data.main_title || 'Obrigado!'}</h1> <p style="color: var(--text-secondary); margin-top: 0.5rem; max-width: 450px; margin-left: auto; margin-right: auto;">${data.subtitle || 'Subt√≠tulo...'}</p> <a href="${data.redirect_url || '#'}" target="_blank" style="display: inline-block; background-color: var(--accent-secondary); color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.375rem; margin-top: 1.5rem; text-decoration: none;"> ${data.button_text || 'Bot√£o'} </a> </div> </div>`;
             }
             function showResultScreen(pageId) { const link = `${FRONTEND_URL}/obrigado/${pageId}`; pageLinkOutput.value = link; resultScreen.classList.remove('hidden'); }
             function hideResultScreen() { resultScreen.classList.add('hidden'); thankYouForm.reset(); updatePreview(); }

            // Listeners
            thankYouForm.removeEventListener('input', updatePreview);
            thankYouForm.addEventListener('input', updatePreview);

            thankYouForm.removeEventListener('submit', thankYouForm._submitListener);
            thankYouForm._submitListener = async (e) => {
                e.preventDefault(); const button = submitBtn; const originalText = button.textContent; button.textContent = 'Salvando...'; button.disabled = true;
                const payload = { page_name: document.getElementById('page_name').value, main_title: document.getElementById('main_title').value, subtitle: document.getElementById('subtitle').value, button_text: document.getElementById('button_text').value, redirect_url: document.getElementById('redirect_url').value, purchase_value: parseFloat(document.getElementById('purchase_value').value), pixel_id: document.getElementById('pixel_id').value, utmify_integration_id: document.getElementById('utmify_integration_id').value || null };
                try {
                    if (App.state.editingThankYouPageId) {
                         await App.apiRequest(`/api/thank-you-pages/${App.state.editingThankYouPageId}`, 'PUT', payload); // Usa PUT e API Key
                         App.showToast('P√°gina atualizada!', 'success'); App.state.editingThankYouPageId = null; App.navigateTo('thankYouPages');
                    } else {
                        const result = await App.apiRequest(`/api/thank-you-pages/create`, 'POST', payload); // Usa POST e API Key
                        showResultScreen(result.pageId);
                    }
                } catch (error) { button.disabled = false; button.textContent = originalText; }
            };
            thankYouForm.addEventListener('submit', thankYouForm._submitListener);

            copyLinkBtn.removeEventListener('click', copyLinkBtn._clickListener);
            copyLinkBtn._clickListener = () => { pageLinkOutput.select(); document.execCommand('copy'); copyLinkBtn.textContent = 'Copiado!'; setTimeout(() => { copyLinkBtn.textContent = 'Copiar Link'; }, 2000); };
            copyLinkBtn.addEventListener('click', copyLinkBtn._clickListener);

            createAnotherBtn.removeEventListener('click', createAnotherBtn._clickListener);
            createAnotherBtn._clickListener = () => { hideResultScreen(); App.state.editingThankYouPageId = null; pageTitle.textContent = 'Criador de P√°gina de Obrigado'; submitBtn.textContent = 'Gerar P√°gina'; };
            createAnotherBtn.addEventListener('click', createAnotherBtn._clickListener);

             // Listener para o bot√£o Voltar/Cancelar
             if(backBtn) {
                 backBtn.removeEventListener('click', backBtn._clickListener);
                 backBtn._clickListener = () => { App.state.editingThankYouPageId = null; App.navigateTo('thankYouPages'); };
                 backBtn.addEventListener('click', backBtn._clickListener);
             }
        },

    };

    App.init();
    </script>
</body>
</html>
